<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPT-UNO - Emulador Impressora Paralela</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button.toggle {
            position: relative;
            padding-left: 50px;
        }
        
        button.toggle::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 16px;
            background: #e74c3c;
            border-radius: 10px;
            transition: background 0.3s;
        }
        
        button.toggle::after {
            content: '';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        
        button.toggle.active::before {
            background: #28a745;
        }
        
        button.toggle.active::after {
            left: 28px;
        }
        
        button.toggle:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.toggle:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .controls-secondary {
            padding: 15px 20px;
            background: #f1f3f5;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        #connectBtn {
            background: #28a745;
            color: white;
        }
        
        #connectBtn:hover {
            background: #218838;
        }
        
        #connectBtn.connected {
            background: #dc3545;
        }
        
        #connectBtn.connected:hover {
            background: #c82333;
        }
        
        #clearBtn {
            background: #ffc107;
            color: #333;
        }
        
        #clearBtn:hover {
            background: #e0a800;
        }
        
        #saveBtn {
            background: #17a2b8;
            color: white;
        }
        
        #saveBtn:hover {
            background: #138496;
        }
        
        #resetBtn {
            background: #ff6b6b;
            color: white;
        }
        
        #resetBtn:hover {
            background: #ee5a52;
        }
        
        #statsBtn {
            background: #6f42c1;
            color: white;
        }
        
        #statsBtn:hover {
            background: #5a32a3;
        }
        
        #printBtn {
            background: #ff6f00;
            color: white;
        }
        
        #printBtn:hover {
            background: #e65100;
        }
        
        #autoSaveBtn {
            background: #00bcd4;
            color: white;
        }
        
        #autoSaveBtn:hover {
            background: #0097a7;
        }
        
        #autoPrintBtn {
            background: #9c27b0;
            color: white;
        }
        
        #autoPrintBtn:hover {
            background: #7b1fa2;
        }
        
        #recipientsBtn {
            background: #ff4081;
            color: white;
        }
        
        #recipientsBtn:hover {
            background: #f50057;
        }
        
        #settingsBtn {
            background: #607d8b;
            color: white;
        }
        
        #settingsBtn:hover {
            background: #455a64;
        }
        
        .status {
            margin-left: auto;
            padding: 12px 24px;
            background: white;
            border-radius: 5px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .stats-bar {
            padding: 15px 20px;
            background: #e9ecef;
            display: flex;
            gap: 30px;
            font-size: 0.9em;
            color: #495057;
        }
        
        .stat-item {
            display: flex;
            gap: 8px;
        }
        
        .stat-label {
            font-weight: 600;
        }
        
        .output-container {
            padding: 20px;
        }
        
        .view-options {
            display: none !important;
        }
        
        .view-btn {
            display: none !important;
        }
        
        .view-btn[data-view="hex"],
        .view-btn[data-view="binary"] {
            display: none !important;
        }
        
        .view-btn.active {
            display: none !important;
        }
        
        /* Modal de Defini√ß√µes */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: slideDown 0.3s;
        }
        
        #emailConfigModal .modal-content {
            max-width: 800px;
        }
        
        #recipientsModal .modal-content {
            max-width: 900px;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1e3c72;
            font-size: 1.5em;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: #f8f9fa;
            color: #dc3545;
            transform: none;
            box-shadow: none;
        }
        
        .modal-section {
            margin-bottom: 20px;
        }
        
        .modal-section:last-child {
            margin-bottom: 0;
        }
        
        .modal-section h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1em;
        }
        
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .modal-option {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-option:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        
        .modal-option.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        .modal-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }
        
        .modal-select-group {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 5px;
        }
        
        .modal-select-group label {
            font-weight: 600;
            color: #495057;
            flex-shrink: 0;
        }
        
        .modal-select-group select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            background: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn {
            width: 100%;
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .form-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #856404;
        }
        
        .form-note strong {
            display: block;
            margin-bottom: 5px;
            color: #664d03;
        }
        
        .field-note {
            background: #e7f3ff;
            border-left: 3px solid #007bff;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #004085;
            line-height: 1.4;
        }
        
        .field-note strong {
            color: #003366;
            font-weight: 700;
        }
        
        .form-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-column {
            display: flex;
            flex-direction: column;
        }
        
        .form-full-width {
            grid-column: 1 / -1;
        }
        
        .modal-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .modal-btn-group .modal-btn {
            flex: 1;
        }
        
        .modal-btn-test {
            background: #28a745;
        }
        
        .modal-btn-test:hover {
            background: #218838;
        }
        
        .tab-btn {
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            background: #f0f0f0 !important;
            color: #667eea;
        }
        
        .tab-btn.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .recipients-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .recipients-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .recipients-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .recipients-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .recipients-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .recipient-row {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .recipient-row input {
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }
        
        .recipient-row input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .recipient-row input::placeholder {
            color: #adb5bd;
        }
        
        .modal-select-group select:hover {
            border-color: #007bff;
        }
        
        .modal-select-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        #output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        
        #output.hex-view {
            color: #00d4ff;
        }
        
        #output::-webkit-scrollbar {
            width: 10px;
        }
        
        #output::-webkit-scrollbar-track {
            background: #2e2e2e;
        }
        
        #output::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        
        #output::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        
        footer {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }
        
        /* ========================================
           DARK MODE THEME
           ======================================== */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.dark-mode .container {
            background: #2d2d2d;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        body.dark-mode header {
            background: linear-gradient(135deg, #434343 0%, #000000 100%);
            color: #e0e0e0;
        }
        
        body.dark-mode .subtitle {
            color: #b0b0b0;
        }
        
        body.dark-mode .controls,
        body.dark-mode .controls-secondary {
            background: #3a3a3a;
            border-bottom-color: #555;
        }
        
        body.dark-mode .stats-bar {
            background: #333;
            color: #b0b0b0;
        }
        
        body.dark-mode #output {
            background: #1e1e1e;
            color: #d4d4d4;
            border-color: #444;
        }
        
        body.dark-mode .status {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-header {
            background: linear-gradient(135deg, #434343 0%, #000000 100%);
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-section {
            background: #3a3a3a;
            border-color: #555;
        }
        
        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="number"],
        body.dark-mode select,
        body.dark-mode textarea {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #555;
        }
        
        body.dark-mode .field-note {
            background: #333;
            border-left-color: #666;
            color: #b0b0b0;
        }
        
        body.dark-mode .recipients-container {
            background: #1e1e1e;
            border-color: #555;
        }
        
        body.dark-mode footer {
            background: #2d2d2d;
            color: #b0b0b0;
            border-top-color: #555;
        }
        
        body.dark-mode table thead {
            background: #333 !important;
        }
        
        body.dark-mode table td,
        body.dark-mode table th {
            border-bottom: 1px solid #555;
        }
        
        /* ========================================
           OCEAN THEME
           ======================================== */
        body.ocean-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #e8f4f8;
        }
        
        body.ocean-theme .container {
            background: linear-gradient(to bottom, #0a4d68, #05161a);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        body.ocean-theme header {
            background: linear-gradient(135deg, #006994 0%, #004d6d 100%);
            color: #e8f4f8;
        }
        
        body.ocean-theme .subtitle {
            color: #a8dadc;
        }
        
        body.ocean-theme .controls,
        body.ocean-theme .controls-secondary {
            background: #0c2d48;
            border-bottom-color: #1b4965;
        }
        
        body.ocean-theme .stats-bar {
            background: #0a3d5c;
            color: #a8dadc;
        }
        
        body.ocean-theme #output {
            background: #041c32;
            color: #cae9ff;
            border-color: #1b4965;
        }
        
        body.ocean-theme .status {
            background: #0c2d48;
            color: #e8f4f8;
        }
        
        body.ocean-theme .modal-content {
            background: #0a3d5c;
            color: #e8f4f8;
        }
        
        body.ocean-theme .modal-header {
            background: linear-gradient(135deg, #006994 0%, #004d6d 100%);
            color: #e8f4f8;
        }
        
        body.ocean-theme .modal-section {
            background: #0c2d48;
            border-color: #1b4965;
        }
        
        body.ocean-theme input[type="text"],
        body.ocean-theme input[type="email"],
        body.ocean-theme input[type="password"],
        body.ocean-theme input[type="number"],
        body.ocean-theme select,
        body.ocean-theme textarea {
            background: #041c32;
            color: #cae9ff;
            border-color: #1b4965;
        }
        
        body.ocean-theme .field-note {
            background: #0c2d48;
            border-left-color: #2196f3;
            color: #a8dadc;
        }
        
        body.ocean-theme #connectBtn {
            background: #0288d1;
        }
        
        body.ocean-theme #connectBtn:hover {
            background: #0277bd;
        }
        
        body.ocean-theme #connectBtn.connected {
            background: #d32f2f;
        }
        
        body.ocean-theme #resetBtn {
            background: #0097a7;
        }
        
        body.ocean-theme #resetBtn:hover {
            background: #00838f;
        }
        
        body.ocean-theme #statsBtn {
            background: #5e35b1;
        }
        
        body.ocean-theme #statsBtn:hover {
            background: #4527a0;
        }
        
        body.ocean-theme #clearBtn {
            background: #ffa726;
        }
        
        body.ocean-theme #clearBtn:hover {
            background: #fb8c00;
        }
        
        body.ocean-theme #saveBtn {
            background: #26c6da;
        }
        
        body.ocean-theme #saveBtn:hover {
            background: #00acc1;
        }
        
        body.ocean-theme #printBtn {
            background: #0277bd;
        }
        
        body.ocean-theme #printBtn:hover {
            background: #01579b;
        }
        
        body.ocean-theme #autoSaveBtn {
            background: #0097a7;
        }
        
        body.ocean-theme #autoSaveBtn:hover {
            background: #00838f;
        }
        
        body.ocean-theme #autoPrintBtn {
            background: #5e35b1;
        }
        
        body.ocean-theme #autoPrintBtn:hover {
            background: #4527a0;
        }
        
        body.ocean-theme #recipientsBtn {
            background: #ec407a;
        }
        
        body.ocean-theme #recipientsBtn:hover {
            background: #d81b60;
        }
        
        body.ocean-theme #settingsBtn {
            background: #455a64;
        }
        
        body.ocean-theme #settingsBtn:hover {
            background: #37474f;
        }
        
        /* ========================================
           FOREST THEME
           ======================================== */
        body.forest-theme {
            background: linear-gradient(135deg, #2d5016 0%, #1a2f0d 100%);
            color: #d5e8cf;
        }
        
        body.forest-theme .container {
            background: linear-gradient(to bottom, #1e3a0f, #0d1f07);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        body.forest-theme header {
            background: linear-gradient(135deg, #2d5016 0%, #1a3409 100%);
            color: #d5e8cf;
        }
        
        body.forest-theme .subtitle {
            color: #a3c796;
        }
        
        body.forest-theme .controls,
        body.forest-theme .controls-secondary {
            background: #243d16;
            border-bottom-color: #345720;
        }
        
        body.forest-theme .stats-bar {
            background: #1a2f0d;
            color: #a3c796;
        }
        
        body.forest-theme #output {
            background: #0f1f08;
            color: #c9e4bd;
            border-color: #345720;
        }
        
        body.forest-theme .status {
            background: #243d16;
            color: #d5e8cf;
        }
        
        body.forest-theme .modal-content {
            background: #1e3a0f;
            color: #d5e8cf;
        }
        
        body.forest-theme .modal-header {
            background: linear-gradient(135deg, #2d5016 0%, #1a3409 100%);
            color: #d5e8cf;
        }
        
        body.forest-theme .modal-section {
            background: #243d16;
            border-color: #345720;
        }
        
        body.forest-theme input[type="text"],
        body.forest-theme input[type="email"],
        body.forest-theme input[type="password"],
        body.forest-theme input[type="number"],
        body.forest-theme select,
        body.forest-theme textarea {
            background: #0f1f08;
            color: #c9e4bd;
            border-color: #345720;
        }
        
        body.forest-theme .field-note {
            background: #243d16;
            border-left-color: #4caf50;
            color: #a3c796;
        }
        
        body.forest-theme #connectBtn {
            background: #388e3c;
        }
        
        body.forest-theme #connectBtn:hover {
            background: #2e7d32;
        }
        
        body.forest-theme #connectBtn.connected {
            background: #d32f2f;
        }
        
        body.forest-theme #resetBtn {
            background: #558b2f;
        }
        
        body.forest-theme #resetBtn:hover {
            background: #33691e;
        }
        
        body.forest-theme #statsBtn {
            background: #7cb342;
        }
        
        body.forest-theme #statsBtn:hover {
            background: #689f38;
        }
        
        body.forest-theme #clearBtn {
            background: #ffa726;
        }
        
        body.forest-theme #clearBtn:hover {
            background: #fb8c00;
        }
        
        body.forest-theme #saveBtn {
            background: #66bb6a;
        }
        
        body.forest-theme #saveBtn:hover {
            background: #4caf50;
        }
        
        body.forest-theme #printBtn {
            background: #558b2f;
        }
        
        body.forest-theme #printBtn:hover {
            background: #33691e;
        }
        
        body.forest-theme #autoSaveBtn {
            background: #43a047;
        }
        
        body.forest-theme #autoSaveBtn:hover {
            background: #388e3c;
        }
        
        body.forest-theme #autoPrintBtn {
            background: #7cb342;
        }
        
        body.forest-theme #autoPrintBtn:hover {
            background: #689f38;
        }
        
        body.forest-theme #recipientsBtn {
            background: #8d6e63;
        }
        
        body.forest-theme #recipientsBtn:hover {
            background: #6d4c41;
        }
        
        body.forest-theme #settingsBtn {
            background: #5d4037;
        }
        
        body.forest-theme #settingsBtn:hover {
            background: #4e342e;
        }
        
        /* ========================================
           SUNSET THEME
           ======================================== */
        body.sunset-theme {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: #ffe5e5;
        }
        
        body.sunset-theme .container {
            background: linear-gradient(to bottom, #6a1b4d, #2d0a24);
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }
        
        body.sunset-theme header {
            background: linear-gradient(135deg, #c44569 0%, #8b2e52 100%);
            color: #ffe5e5;
        }
        
        body.sunset-theme .subtitle {
            color: #ffb3c6;
        }
        
        body.sunset-theme .controls,
        body.sunset-theme .controls-secondary {
            background: #4a1942;
            border-bottom-color: #6b2454;
        }
        
        body.sunset-theme .stats-bar {
            background: #3a1235;
            color: #ffb3c6;
        }
        
        body.sunset-theme #output {
            background: #2d0a24;
            color: #ffd3e0;
            border-color: #6b2454;
        }
        
        body.sunset-theme .status {
            background: #4a1942;
            color: #ffe5e5;
        }
        
        body.sunset-theme .modal-content {
            background: #3a1235;
            color: #ffe5e5;
        }
        
        body.sunset-theme .modal-header {
            background: linear-gradient(135deg, #c44569 0%, #8b2e52 100%);
            color: #ffe5e5;
        }
        
        body.sunset-theme .modal-section {
            background: #4a1942;
            border-color: #6b2454;
        }
        
        body.sunset-theme input[type="text"],
        body.sunset-theme input[type="email"],
        body.sunset-theme input[type="password"],
        body.sunset-theme input[type="number"],
        body.sunset-theme select,
        body.sunset-theme textarea {
            background: #2d0a24;
            color: #ffd3e0;
            border-color: #6b2454;
        }
        
        body.sunset-theme .field-note {
            background: #4a1942;
            border-left-color: #ff6b9d;
            color: #ffb3c6;
        }
        
        body.sunset-theme table thead {
            background: #4a1942 !important;
        }
        
        body.sunset-theme table td,
        body.sunset-theme table th {
            border-bottom: 1px solid #6b2454;
        }
        
        body.sunset-theme #connectBtn {
            background: #ec407a;
        }
        
        body.sunset-theme #connectBtn:hover {
            background: #d81b60;
        }
        
        body.sunset-theme #connectBtn.connected {
            background: #ef5350;
        }
        
        body.sunset-theme #resetBtn {
            background: #ab47bc;
        }
        
        body.sunset-theme #resetBtn:hover {
            background: #9c27b0;
        }
        
        body.sunset-theme #statsBtn {
            background: #7e57c2;
        }
        
        body.sunset-theme #statsBtn:hover {
            background: #673ab7;
        }
        
        body.sunset-theme #clearBtn {
            background: #ffa726;
        }
        
        body.sunset-theme #clearBtn:hover {
            background: #fb8c00;
        }
        
        body.sunset-theme #saveBtn {
            background: #26a69a;
        }
        
        body.sunset-theme #saveBtn:hover {
            background: #00897b;
        }
        
        body.sunset-theme #printBtn {
            background: #d4526e;
        }
        
        body.sunset-theme #printBtn:hover {
            background: #c2185b;
        }
        
        body.sunset-theme #autoSaveBtn {
            background: #26a69a;
        }
        
        body.sunset-theme #autoSaveBtn:hover {
            background: #00897b;
        }
        
        body.sunset-theme #autoPrintBtn {
            background: #ab47bc;
        }
        
        body.sunset-theme #autoPrintBtn:hover {
            background: #9c27b0;
        }
        
        body.sunset-theme #recipientsBtn {
            background: #f06292;
        }
        
        body.sunset-theme #recipientsBtn:hover {
            background: #ec407a;
        }
        
        body.sunset-theme #settingsBtn {
            background: #8e24aa;
        }
        
        body.sunset-theme #settingsBtn:hover {
            background: #7b1fa2;
        }
        
        /* Anima√ß√£o para bot√£o de pasta (primeira vez) */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 20px 10px rgba(40, 167, 69, 0);
            }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ®Ô∏è LPT-UNO</h1>
            <p class="subtitle">Emulador de Impressora Paralela</p>
            <p id="firmwareInfo" style="margin-top: 10px; opacity: 0.8; font-size: 0.9em;">Web Interface v1.0 | Build: 2026-01-25</p>
        </header>
        
        <div class="controls">
            <button id="connectBtn">üîå Conectar Arduino</button>
            <button id="resetBtn">üîÑ Reset Buffer</button>
            <button id="clearBtn">üóëÔ∏è Limpar</button>
            
            <div style="flex: 1;"></div>
            
            <button id="recipientsBtn">üìß Configurar Destinat√°rios</button>
            <button id="settingsBtn">‚öôÔ∏è Defini√ß√µes</button>
            
            <div class="status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Desconectado</span>
            </div>
        </div>
        
        <div class="controls-secondary">
            <button id="saveBtn">üíæ Salvar Agora</button>
            <button id="printBtn">üñ®Ô∏è Imprimir Agora</button>
            
            <button id="autoSaveBtn" class="toggle active">üíæ Auto-salvar</button>
            <button id="autoPrintBtn" class="toggle" title="Para impress√£o direta sem di√°logo, consulte o guia GUIA_IMPRESSAO_SILENCIOSA.md">üñ®Ô∏è Auto-imprimir</button>
            <div style="flex: 1;"></div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="display: flex; flex-direction: column; gap: 3px;">
                    <label for="subfolderNameInput" style="font-size: 0.85em; color: #666; white-space: nowrap;">Nome do ficheiro:</label>
                    <input type="text" id="subfolderNameInput" placeholder="Ex: Cliente_A" 
                           style="width: 160px; padding: 6px 10px; border: 2px solid #007bff; border-radius: 5px; font-size: 0.9em;" title="Prefixo do arquivo: [nome]_[timestamp].ext">
                </div>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">Bytes recebidos:</span>
                <span id="byteCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Taxa:</span>
                <span id="dataRate">0 B/s</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Tempo ativo:</span>
                <span id="uptime">00:00:00</span>
            </div>
        </div>
        
        <div class="output-container">
            <div class="info-message" id="infoMsg">
                ‚ÑπÔ∏è Clique em "Conectar Arduino" e selecione a porta COM do Arduino Uno (115200 baud)
            </div>
            
            <div class="error-message" id="errorMsg"></div>
            
            <div id="output"></div>
        </div>
        
        <!-- Modal de Defini√ß√µes -->
        <div id="settingsModal" class="modal">
            <div class="modal-content" style="max-width: 1100px;">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Defini√ß√µes</h2>
                    <button class="modal-close" id="closeModal">√ó</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; align-items: start;">
                    
                    <!-- üìä COLUNA 1: VISUALIZA√á√ÉO -->
                    <div>
                        <h3 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 15px;">
                            üìä Visualiza√ß√£o
                        </h3>
                        
                        <div class="modal-section">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">Modo de Visualiza√ß√£o</h4>
                            <div class="modal-options">
                                <label class="modal-option selected" data-view="text">
                                    <input type="radio" name="viewMode" value="text" checked>
                                    <span>üìù Texto (ASCII)</span>
                                </label>
                                <label class="modal-option" data-view="hex">
                                    <input type="radio" name="viewMode" value="hex">
                                    <span>üî¢ Hexadecimal</span>
                                </label>
                                <label class="modal-option" data-view="binary">
                                    <input type="radio" name="viewMode" value="binary">
                                    <span>üíª Bin√°rio</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="modal-section" style="margin-top: 20px;">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">‚è±Ô∏è Auto-Salvar</h4>
                            <div class="modal-select-group">
                                <label for="autoSaveTime" style="font-size: 0.9em;">Tempo de Inatividade:</label>
                                <select id="autoSaveTime">
                                    <option value="10">10 segundos</option>
                                    <option value="15">15 segundos</option>
                                    <option value="30">30 segundos</option>
                                    <option value="60">1 minuto</option>
                                    <option value="120">2 minutos</option>
                                    <option value="300">5 minutos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üé® COLUNA 2: INTERFACE -->
                    <div>
                        <h3 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px; margin-bottom: 15px;">
                            üé® Interface
                        </h3>
                        
                        <div class="modal-section">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;" id="langSectionTitle">üåê Idioma</h4>
                            <div class="modal-select-group">
                                <label for="languageSelect" id="langLabel" style="font-size: 0.9em;">Selecione:</label>
                                <select id="languageSelect">
                                    <option value="en">üá¨üáß English</option>
                                    <option value="pt">üáµüáπ Portugu√™s</option>
                                    <option value="es">üá™üá∏ Espa√±ol</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="modal-section" style="margin-top: 20px;">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">üé® Tema Visual</h4>
                            <div class="modal-select-group">
                                <label for="themeSelect" style="font-size: 0.9em;">Selecione:</label>
                                <select id="themeSelect">
                                    <option value="light">‚òÄÔ∏è Light</option>
                                    <option value="dark">üåô Dark</option>
                                    <option value="ocean">üåä Ocean</option>
                                    <option value="forest">üå≤ Forest</option>
                                    <option value="sunset">üåÖ Sunset</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="modal-section" style="margin-top: 20px;">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">üîî Notifica√ß√µes</h4>
                            <button id="notificationsToggle" class="toggle" style="width: 100%; justify-content: center;">
                                üîî Notifica√ß√µes Desktop
                            </button>
                        </div>
                    </div>
                    
                    <!-- üíæ COLUNA 3: ARQUIVOS -->
                    <div>
                        <h3 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px; margin-bottom: 15px;">
                            üíæ Arquivos
                        </h3>
                        
                        <div class="modal-section">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">üíæ Formato de Grava√ß√£o</h4>
                            <div class="modal-options">
                                <label class="modal-option selected" data-format="txt">
                                    <input type="radio" name="saveFormat" value="txt" checked>
                                    <span>üìù Texto (.txt)</span>
                                </label>
                                <label class="modal-option" data-format="csv">
                                    <input type="radio" name="saveFormat" value="csv">
                                    <span>üìä CSV (.csv)</span>
                                </label>
                                <label class="modal-option" data-format="pdf">
                                    <input type="radio" name="saveFormat" value="pdf">
                                    <span>üìÑ PDF (.pdf)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="modal-section" style="margin-top: 20px;">
                            <h4 style="font-size: 0.95em; margin-bottom: 10px;">üîß Avan√ßado</h4>
                            <button class="modal-btn" id="openEmailConfig" style="width: 100%; margin-bottom: 8px;">
                                üìß Configurar Email
                            </button>
                            <button class="modal-btn" id="openSessionHistory" style="background: #17a2b8; width: 100%;">
                                üíæ Hist√≥rico de Sess√µes
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <!-- Modal de Configura√ß√£o de Email -->
        <div id="emailConfigModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="emailConfigTitle">üìß Configura√ß√£o de Email</h2>
                    <button class="modal-close" id="closeEmailModal">√ó</button>
                </div>
                
                <form id="emailForm">
                    <div class="form-group form-full-width">
                        <h3 style="color: #007bff; margin-bottom: 15px;">üöÄ Google Apps Script - Envio Gratuito e Ilimitado!</h3>
                        <div class="field-note" style="background: #d1ecf1; border-left-color: #0c5460; color: #0c5460; margin-bottom: 20px;">
                            <strong>‚ö° Configura√ß√£o Assistida - M√°xima Automa√ß√£o Poss√≠vel!</strong><br>
                            Clique no bot√£o abaixo e siga os passos guiados. O sistema faz tudo automaticamente! üéâ
                        </div>
                        <button type="button" class="modal-btn" id="autoConfigScriptBtn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.1em; padding: 15px;">
                            üöÄ Configurar Script Automaticamente
                        </button>
                        
                        <div id="wizardSteps" style="display: none; margin-top: 20px;">
                            <!-- Passo 1 -->
                            <div id="step1" class="wizard-step" style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìã Passo 1: Script Copiado!</h4>
                                <p style="margin: 5px 0; line-height: 1.6;">
                                    ‚úÖ O c√≥digo foi copiado automaticamente para a √°rea de transfer√™ncia.<br>
                                    üåê Uma nova janela do Google Apps Script vai abrir em 3 segundos...<br>
                                    ‚è≥ <strong id="countdown">3</strong>
                                </p>
                            </div>
                            
                            <!-- Passo 2 -->
                            <div id="step2" class="wizard-step" style="display: none; background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                <h4 style="margin: 0 0 10px 0; color: #f57c00;">üìù Passo 2: Cole o C√≥digo</h4>
                                <p style="margin: 5px 0; line-height: 1.6;">
                                    Na janela que abriu:<br>
                                    <strong>1.</strong> Fa√ßa login com sua conta Gmail (se necess√°rio)<br>
                                    <strong>2.</strong> Clique em <strong>"Novo projeto"</strong><br>
                                    <strong>3.</strong> Apague o c√≥digo padr√£o<br>
                                    <strong>4.</strong> Cole o c√≥digo copiado (<strong>Ctrl+V</strong> ou <strong>Cmd+V</strong>)<br>
                                    <strong>5.</strong> Prossiga para o pr√≥ximo passo! ‚û°Ô∏è
                                </p>
                            </div>
                            
                            <!-- Passo 3 -->
                            <div id="step3" class="wizard-step" style="display: none; background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                <h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üöÄ Passo 3: Implantar como Web App</h4>
                                <p style="margin: 5px 0; line-height: 1.6;">
                                    No editor do Apps Script:<br>
                                    <strong>1.</strong> Clique no bot√£o <strong>"Implantar"</strong> (canto superior direito)<br>
                                    <strong>2.</strong> Selecione <strong>"Nova implanta√ß√£o"</strong><br>
                                    <strong>3.</strong> Clique na ‚öôÔ∏è engrenagem e escolha <strong>"Web app"</strong><br>
                                    <strong>4.</strong> Configure:<br>
                                    &nbsp;&nbsp;&nbsp;‚Ä¢ Executar como: <strong>"Eu"</strong><br>
                                    &nbsp;&nbsp;&nbsp;‚Ä¢ Quem tem acesso: <strong>"Qualquer pessoa"</strong><br>
                                    <strong>5.</strong> Clique em <strong>"Implantar"</strong><br>
                                    <strong>6.</strong> Autorize o script (clique em "Autorizar acesso")<br>
                                    <strong>7.</strong> Copie a <strong>URL do Web app</strong> gerada
                                </p>
                            </div>
                            
                            <!-- Passo 4 -->
                            <div id="step4" class="wizard-step" style="display: none; background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                <h4 style="margin: 0 0 10px 0; color: #2e7d32;">‚úÖ Passo 4: Quase Pronto!</h4>
                                <p style="margin: 5px 0; line-height: 1.6;">
                                    Quando terminar, <strong>cole a URL abaixo</strong> e clique em <strong>"Validar e Salvar"</strong>.<br>
                                    O sistema ir√° verificar e configurar tudo automaticamente! üéâ
                                </p>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <input type="text" id="wizardUrlInput" placeholder="Cole aqui: https://script.google.com/macros/s/.../exec" style="flex: 1; padding: 10px; border: 2px solid #4caf50; border-radius: 5px; font-size: 0.95em;">
                                    <button type="button" id="validateUrlBtn" class="modal-btn" style="background: #4caf50; white-space: nowrap;">
                                        ‚úÖ Validar e Salvar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em; color: #6c757d;">
                            üí° <strong>Dica:</strong> Mantenha esta janela aberta enquanto configura o script!
                        </div>
                    </div>
                    
                    <div class="form-group form-full-width">
                        <label for="appsScriptUrl" id="appsScriptUrlLabel">URL do Google Apps Script:</label>
                        <div class="field-note" id="appsScriptUrlNote">
                            <strong>Formato:</strong> https://script.google.com/macros/s/SEU_ID_AQUI/exec<br>
                            <strong>Como obter:</strong> Apps Script ‚Üí Implantar ‚Üí Nova implanta√ß√£o ‚Üí Web app ‚Üí Copiar URL
                        </div>
                        <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec" value="">
                    </div>
                    
                    <div class="form-group form-full-width">
                        <label for="senderName" id="senderNameLabel">Nome do Remetente (Opcional):</label>
                        <input type="text" id="senderName" placeholder="LPT-UNO" value="LPT-UNO">
                    </div>
                    
                    <div class="modal-btn-group">
                        <button type="button" class="modal-btn modal-btn-test" id="testEmailConfig">‚úÖ Testar Configura√ß√£o</button>
                        <button type="submit" class="modal-btn" id="saveEmailConfig">üíæ Salvar Configura√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal de Configurar Destinat√°rios -->
        <div id="recipientsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="recipientsTitle">üìß Configurar Destinat√°rios</h2>
                    <button class="modal-close" id="closeRecipientsModal">√ó</button>
                </div>
                
                <div style="padding: 15px 20px; background: #e3f2fd; border-left: 4px solid #2196f3; margin-bottom: 20px; border-radius: 5px;">
                    <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">
                        <strong>‚ÑπÔ∏è Como funciona:</strong><br>
                        O sistema procura <strong>automaticamente</strong> os nomes configurados nos dados recebidos (ex: "Jo√£o Silva").<br>
                        Quando encontra uma correspond√™ncia (ignora mai√∫sculas/min√∫sculas), envia o email automaticamente para o destinat√°rio.<br>
                        <em>Exemplo: Se configurar "Maria Santos", qualquer dado contendo "maria santos" ou "MARIA SANTOS" ativa o envio.</em>
                    </p>
                </div>
                
                <div class="recipients-container" id="recipientsContainer">
                    <!-- Linhas ser√£o adicionadas dinamicamente -->
                </div>
                
                <button type="button" class="modal-btn" id="saveRecipients">üíæ Salvar Destinat√°rios</button>
            </div>
        </div>
        
        <!-- Modal de Hist√≥rico de Sess√µes e Backups -->
        <div id="sessionHistoryModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>üíæ Hist√≥rico de Sess√µes e Backups</h2>
                    <button class="modal-close" id="closeSessionHistory">√ó</button>
                </div>
                
                <!-- Tabs para alternar entre Sess√µes e Backups -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button id="tabSessions" class="tab-btn active" style="flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; font-weight: bold; border-bottom: 3px solid #667eea;">
                        üìÇ Sess√µes Salvas
                    </button>
                    <button id="tabBackups" class="tab-btn" style="flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent;">
                        üîÑ Backups Autom√°ticos
                    </button>
                </div>
                
                <!-- Conte√∫do: Sess√µes Salvas -->
                <div id="sessionsContent" style="display: block;">
                    <div style="max-height: 500px; overflow-y: auto;" id="sessionHistoryList">
                        <p style="padding: 20px; text-align: center; color: #6c757d;">
                            Nenhuma sess√£o salva ainda
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="button" class="modal-btn" id="clearSessionHistory" style="background: #dc3545;">
                            üóëÔ∏è Limpar Todas as Sess√µes
                        </button>
                    </div>
                </div>
                
                <!-- Conte√∫do: Backups Autom√°ticos -->
                <div id="backupsContent" style="display: none;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                        <strong>‚ÑπÔ∏è Sistema de Backup Autom√°tico</strong>
                        <p style="margin: 10px 0 0 0;">
                            ‚Ä¢ Backup a cada 30 segundos enquanto houver dados<br>
                            ‚Ä¢ Backup autom√°tico ao fechar p√°gina<br>
                            ‚Ä¢ M√°ximo de 50 backups (mais antigos s√£o removidos)<br>
                            ‚Ä¢ Backups salvos no navegador (IndexedDB)<br>
                            ‚Ä¢ Arquivos baixados v√£o para pasta Downloads
                        </p>
                    </div>
                    
                    <div id="backupStats" style="padding: 10px; background: #f5f5f5; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
                        <span id="backupCount">Carregando...</span>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;" id="backupList">
                        <p style="padding: 20px; text-align: center; color: #6c757d;">
                            Nenhum backup encontrado
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="modal-btn" id="refreshBackups" style="background: #28a745;">
                            üîÑ Atualizar Lista
                        </button>
                        <button type="button" class="modal-btn" id="exportAllBackups" style="background: #17a2b8;">
                            üì¶ Exportar Todos os Backups
                        </button>
                        <button type="button" class="modal-btn" id="clearAllBackups" style="background: #dc3545;">
                            üóëÔ∏è Limpar Todos os Backups
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p><strong>LPT-UNO</strong> | Interface Paralela LPT (DB25) | Web Serial API</p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                Requer navegador compat√≠vel com Web Serial API (Chrome, Edge, Opera)
            </p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                üìß Contacto: <a href="mailto:aharmonica@sapo.pt" style="color: #667eea; text-decoration: none;">aharmonica@sapo.pt</a>
            </p>
        </footer>
    </div>

    <script>
        // Vari√°veis globais
        let port = null;
        let reader = null;
        let writer = null;
        let isConnected = false;
        let byteCount = 0;
        let startTime = null;
        let lastByteCount = 0;
        let currentView = 'text';
        let inactivityTimer = null;
        let lastDataTime = null;
        let pendingData = '';
        let firmwareVersion = 'Unknown';
        let firmwareBuild = 'Unknown';
        
        // Novas vari√°veis para melhorias
        let autoReconnectEnabled = true;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let reconnectTimer = null;
        
        // Elementos do Monitor LPT
        const ledStrobe = document.getElementById('ledStrobe');
        const ledBusy = document.getElementById('ledBusy');
        const ledAck = document.getElementById('ledAck');
        const ledSelect = document.getElementById('ledSelect');
        const dataLeds = [
            document.getElementById('ledD0'),
            document.getElementById('ledD1'),
            document.getElementById('ledD2'),
            document.getElementById('ledD3'),
            document.getElementById('ledD4'),
            document.getElementById('ledD5'),
            document.getElementById('ledD6'),
            document.getElementById('ledD7')
        ];
        const hexValueDisplay = document.getElementById('hexValue');
        
        // Sistema de Tradu√ß√£o (i18n)
        const translations = {
            pt: {
                title: 'LPT-UNO - Emulador Impressora Paralela',
                subtitle: 'Emulador de Impressora Paralela - Arduino Uno',
                connect: 'Conectar Arduino',
                disconnect: 'Desconectar',
                reset: 'Reset Buffer',
                stats: 'Estat√≠sticas',
                clear: 'Limpar',
                settings: 'Defini√ß√µes',
                connected: 'Conectado',
                disconnected: 'Desconectado',
                saveNow: 'Salvar Agora',
                printNow: 'Imprimir Agora',
                autoSave: 'Auto-salvar',
                autoPrint: 'Auto-imprimir',
                bytesReceived: 'Bytes recebidos:',
                rate: 'Taxa:',
                uptime: 'Tempo ativo:',
                infoMessage: 'Clique em "Conectar Arduino" e selecione a porta COM do Arduino Uno (115200 baud)',
                settingsTitle: 'Defini√ß√µes',
                viewMode: 'Modo de Visualiza√ß√£o',
                textMode: 'Texto (ASCII)',
                hexMode: 'Hexadecimal',
                binaryMode: 'Bin√°rio',
                autoSaveTime: 'Tempo de Auto-Salvar',
                inactivity: 'Inatividade:',
                seconds: 'segundos',
                minute: 'minuto',
                minutes: 'minutos',
                language: 'Idioma',
                selectLanguage: 'Selecione o idioma:',
                footer1: 'Interface Paralela LPT (DB25) | Web Serial API',
                footer2: 'Requer navegador compat√≠vel com Web Serial API (Chrome, Edge, Opera)',
                contact: 'Contacto:',
                webInterface: 'Web Interface',
                arduinoFirmware: 'Arduino Firmware',
                noData: 'Nenhum dado para',
                save: 'salvar',
                print: 'imprimir',
                activated: 'ativado',
                deactivated: 'desativado',
                fileSaved: 'Arquivo salvo',
                sentToPrinter: 'Enviado para impressora padr√£o',
                autoSaved: 'Arquivo salvo automaticamente:',
                viewModeChanged: 'Modo de visualiza√ß√£o:',
                autoSaveTimeChanged: 'Tempo de auto-salvar:',
                languageChanged: 'Idioma alterado para:',
                configureEmail: 'Configurar Email',
                emailConfigTitle: 'Configura√ß√£o de Email',
                smtpServerNote: '<strong>Gmail:</strong> smtp.gmail.com | <strong>Sapo:</strong> smtp.sapo.pt | <strong>Hotmail/Outlook:</strong> smtp-mail.outlook.com',
                smtpPortNote: '<strong>TLS:</strong> 587 (recomendado) | <strong>SSL:</strong> 465',
                smtpPasswordNote: '<strong>‚ö†Ô∏è Gmail:</strong> Use "Senha de Aplicativo" (n√£o a senha normal). Gere em: Conta Google ‚Üí Seguran√ßa ‚Üí Verifica√ß√£o em duas etapas ‚Üí Senhas de app',
                senderName: 'Nome do Remetente:',
                senderEmail: 'Email do Remetente:',
                smtpServer: 'Servidor SMTP:',
                smtpPort: 'Porta SMTP:',
                smtpSecure: 'Tipo de Seguran√ßa:',
                smtpUser: 'Usu√°rio SMTP:',
                smtpPassword: 'Senha/App Password:',
                saveEmailConfig: 'Salvar Configura√ß√µes',
                testEmailConfig: 'Testar Configura√ß√£o',
                emailConfigSaved: 'Configura√ß√µes de email salvas com sucesso!',
                testingEmail: 'Testando configura√ß√£o de email...',
                emailTestSuccess: 'Teste bem-sucedido! Verifique sua caixa de entrada.',
                emailTestError: 'Erro ao testar: Verifique suas configura√ß√µes.',
                emailTestNote: 'Nota: Envio de email via navegador requer backend. Esta fun√ß√£o valida os campos.',
                fillAllFields: 'Por favor, preencha todos os campos obrigat√≥rios.',
                configureRecipients: 'Configurar Destinat√°rios',
                recipientsTitle: 'Configurar Destinat√°rios',
                recipientName: 'Nome do Destinat√°rio',
                recipientEmail: 'Email(s) - separe v√°rios com v√≠rgula',
                saveRecipients: 'Salvar Destinat√°rios',
                recipientsSaved: 'Destinat√°rios salvos com sucesso!',
                errorConnect: 'Erro ao conectar:',
                errorDisconnect: 'Erro ao desconectar:',
                errorRead: 'Erro na leitura:',
                errorCommand: 'Erro ao enviar comando:',
                errorStats: 'Erro ao solicitar estat√≠sticas:',
                errorPrint: 'Erro ao imprimir:',
                notConnected: 'Arduino n√£o conectado',
                apiNotSupported: 'Web Serial API n√£o suportada. Use Chrome, Edge ou Opera.',
                manual: '(Manual)',
                silentModeActive: '‚úÖ Modo de impress√£o silenciosa ATIVO',
                silentModeDisabled: 'üõë Impress√£o Silenciosa DESATIVADA. Abra pelo arquivo LPT-UNO.bat para ativar.',
                autoDetectFound: 'üîå Detec√ß√£o autom√°tica: Dispositivo encontrado! Conectando...',
                connectionLost: '‚ö†Ô∏è Conex√£o perdida! Tentativa de reconex√£o',
                reconnectFailed: '‚ùå Falha na reconex√£o autom√°tica ap√≥s 5 tentativas.',
                bufferCleared: 'Buffer limpo automaticamente (P√≥s-conex√£o)'
            },
            en: {
                title: 'LPT-UNO - Parallel Printer Emulator',
                subtitle: 'Parallel Printer Emulator - Arduino Uno',
                connect: 'Connect Arduino',
                disconnect: 'Disconnect',
                reset: 'Reset Buffer',
                stats: 'Statistics',
                clear: 'Clear',
                settings: 'Settings',
                connected: 'Connected',
                disconnected: 'Disconnected',
                saveNow: 'Save Now',
                printNow: 'Print Now',
                autoSave: 'Auto-save',
                autoPrint: 'Auto-print',
                bytesReceived: 'Bytes received:',
                rate: 'Rate:',
                uptime: 'Uptime:',
                infoMessage: 'Click "Connect Arduino" and select the Arduino Uno COM port (115200 baud)',
                settingsTitle: 'Settings',
                viewMode: 'Display Mode',
                textMode: 'Text (ASCII)',
                hexMode: 'Hexadecimal',
                binaryMode: 'Binary',
                autoSaveTime: 'Auto-Save Time',
                inactivity: 'Inactivity:',
                seconds: 'seconds',
                minute: 'minute',
                minutes: 'minutes',
                language: 'Language',
                selectLanguage: 'Select language:',
                footer1: 'Parallel Interface LPT (DB25) | Web Serial API',
                footer2: 'Requires browser compatible with Web Serial API (Chrome, Edge, Opera)',
                contact: 'Contact:',
                webInterface: 'Web Interface',
                arduinoFirmware: 'Arduino Firmware',
                noData: 'No data to',
                save: 'save',
                print: 'print',
                activated: 'activated',
                deactivated: 'deactivated',
                fileSaved: 'File saved',
                sentToPrinter: 'Sent to default printer',
                autoSaved: 'File saved automatically:',
                viewModeChanged: 'Display mode:',
                autoSaveTimeChanged: 'Auto-save time:',
                languageChanged: 'Language changed to:',
                configureEmail: 'Configure Email',
                emailConfigTitle: 'Email Configuration',
                smtpServerNote: '<strong>Gmail:</strong> smtp.gmail.com | <strong>Sapo:</strong> smtp.sapo.pt | <strong>Hotmail/Outlook:</strong> smtp-mail.outlook.com',
                smtpPortNote: '<strong>TLS:</strong> 587 (recommended) | <strong>SSL:</strong> 465',
                smtpPasswordNote: '<strong>‚ö†Ô∏è Gmail:</strong> Use "App Password" (not regular password). Generate at: Google Account ‚Üí Security ‚Üí 2-Step Verification ‚Üí App passwords',
                senderName: 'Sender Name:',
                senderEmail: 'Sender Email:',
                smtpServer: 'SMTP Server:',
                smtpPort: 'SMTP Port:',
                smtpSecure: 'Security Type:',
                smtpUser: 'SMTP User:',
                smtpPassword: 'Password/App Password:',
                saveEmailConfig: 'Save Settings',
                testEmailConfig: 'Test Configuration',
                emailConfigSaved: 'Email settings saved successfully!',
                testingEmail: 'Testing email configuration...',
                emailTestSuccess: 'Test successful! Check your inbox.',
                emailTestError: 'Test error: Check your settings.',
                emailTestNote: 'Note: Sending email via browser requires backend. This validates fields.',
                fillAllFields: 'Please fill in all required fields.',
                configureRecipients: 'Configure Recipients',
                recipientsTitle: 'Configure Recipients',
                recipientName: 'Recipient Name',
                recipientEmail: 'Email(s) - separate multiple with comma',
                saveRecipients: 'Save Recipients',
                recipientsSaved: 'Recipients saved successfully!',
                errorConnect: 'Connection error:',
                errorDisconnect: 'Disconnection error:',
                errorRead: 'Read error:',
                errorCommand: 'Error sending command:',
                errorStats: 'Error requesting statistics:',
                errorPrint: 'Print error:',
                notConnected: 'Arduino not connected',
                apiNotSupported: 'Web Serial API not supported. Use Chrome, Edge or Opera.',
                manual: '(Manual)',
                silentModeActive: '‚úÖ Silent print mode ACTIVE',
                silentModeDisabled: 'üõë Silent Printing DISABLED. Open via LPT-UNO.bat to activate.',
                autoDetectFound: 'üîå Auto-detection: Device found! Connecting...',
                connectionLost: '‚ö†Ô∏è Connection lost! Reconnection attempt',
                reconnectFailed: '‚ùå Auto-reconnection failed after 5 attempts.',
                bufferCleared: 'Buffer cleared automatically (Post-connection)'
            },
            es: {
                title: 'LPT-UNO - Emulador Impresora Paralela',
                subtitle: 'Emulador de Impresora Paralela - Arduino Uno',
                connect: 'Conectar Arduino',
                disconnect: 'Desconectar',
                reset: 'Reiniciar Buffer',
                stats: 'Estad√≠sticas',
                clear: 'Limpiar',
                settings: 'Configuraci√≥n',
                connected: 'Conectado',
                disconnected: 'Desconectado',
                saveNow: 'Guardar Ahora',
                printNow: 'Imprimir Ahora',
                autoSave: 'Auto-guardar',
                autoPrint: 'Auto-imprimir',
                bytesReceived: 'Bytes recibidos:',
                rate: 'Tasa:',
                uptime: 'Tiempo activo:',
                infoMessage: 'Haga clic en "Conectar Arduino" y seleccione el puerto COM del Arduino Uno (115200 baud)',
                settingsTitle: 'Configuraci√≥n',
                viewMode: 'Modo de Visualizaci√≥n',
                textMode: 'Texto (ASCII)',
                hexMode: 'Hexadecimal',
                binaryMode: 'Binario',
                autoSaveTime: 'Tiempo de Auto-Guardado',
                inactivity: 'Inactividad:',
                seconds: 'segundos',
                minute: 'minuto',
                minutes: 'minutos',
                language: 'Idioma',
                selectLanguage: 'Seleccione el idioma:',
                footer1: 'Interfaz Paralela LPT (DB25) | Web Serial API',
                footer2: 'Requiere navegador compatible con Web Serial API (Chrome, Edge, Opera)',
                contact: 'Contacto:',
                webInterface: 'Interfaz Web',
                arduinoFirmware: 'Firmware Arduino',
                noData: 'No hay datos para',
                save: 'guardar',
                print: 'imprimir',
                activated: 'activado',
                deactivated: 'desactivado',
                fileSaved: 'Archivo guardado',
                sentToPrinter: 'Enviado a impresora predeterminada',
                autoSaved: 'Archivo guardado autom√°ticamente:',
                viewModeChanged: 'Modo de visualizaci√≥n:',
                autoSaveTimeChanged: 'Tiempo de auto-guardado:',
                languageChanged: 'Idioma cambiado a:',
                configureEmail: 'Configurar Email',
                emailConfigTitle: 'Configuraci√≥n de Email',
                smtpServerNote: '<strong>Gmail:</strong> smtp.gmail.com | <strong>Sapo:</strong> smtp.sapo.pt | <strong>Hotmail/Outlook:</strong> smtp-mail.outlook.com',
                smtpPortNote: '<strong>TLS:</strong> 587 (recomendado) | <strong>SSL:</strong> 465',
                smtpPasswordNote: '<strong>‚ö†Ô∏è Gmail:</strong> Use "Contrase√±a de Aplicaci√≥n" (no la contrase√±a normal). Genere en: Cuenta de Google ‚Üí Seguridad ‚Üí Verificaci√≥n en dos pasos ‚Üí Contrase√±as de aplicaciones',
                senderName: 'Nombre del Remitente:',
                senderEmail: 'Email del Remitente:',
                smtpServer: 'Servidor SMTP:',
                smtpPort: 'Puerto SMTP:',
                smtpSecure: 'Tipo de Seguridad:',
                smtpUser: 'Usuario SMTP:',
                smtpPassword: 'Contrase√±a/App Password:',
                saveEmailConfig: 'Guardar Configuraci√≥n',
                testEmailConfig: 'Probar Configuraci√≥n',
                emailConfigSaved: '¬°Configuraci√≥n de email guardada con √©xito!',
                testingEmail: 'Probando configuraci√≥n de email...',
                emailTestSuccess: '¬°Prueba exitosa! Verifique su bandeja de entrada.',
                emailTestError: 'Error en prueba: Verifique su configuraci√≥n.',
                emailTestNote: 'Nota: Enviar email desde el navegador requiere backend. Esto valida los campos.',
                fillAllFields: 'Por favor, complete todos los campos obligatorios.',
                configureRecipients: 'Configurar Destinatarios',
                recipientsTitle: 'Configurar Destinatarios',
                recipientName: 'Nombre del Destinatario',
                recipientEmail: 'Email(s) - separe varios con coma',
                saveRecipients: 'Guardar Destinatarios',
                recipientsSaved: '¬°Destinatarios guardados con √©xito!',
                errorConnect: 'Error al conectar:',
                errorDisconnect: 'Error al desconectar:',
                errorRead: 'Error de lectura:',
                errorCommand: 'Error al enviar comando:',
                errorStats: 'Error al solicitar estad√≠sticas:',
                errorPrint: 'Error al imprimir:',
                notConnected: 'Arduino no conectado',
                apiNotSupported: 'Web Serial API no compatible. Use Chrome, Edge u Opera.',
                manual: '(Manual)',
                silentModeActive: '‚úÖ Modo de impresi√≥n silenciosa ACTIVO',
                silentModeDisabled: 'üõë Impresi√≥n Silenciosa DESACTIVADA. Abra con LPT-UNO.bat para activar.',
                autoDetectFound: 'üîå Detecci√≥n autom√°tica: ¬°Dispositivo encontrado! Conectando...',
                connectionLost: '‚ö†Ô∏è ¬°Conexi√≥n perdida! Intento de reconexi√≥n',
                reconnectFailed: '‚ùå Fall√≥ la reconexi√≥n autom√°tica despu√©s de 5 intentos.',
                bufferCleared: 'Buffer limpiado autom√°ticamente (Post-conexi√≥n)'
            }
        };
        
        let currentLanguage = 'en';
        
        // LocalStorage - Salvar prefer√™ncias
        const STORAGE_KEY = 'lpt-uno-preferences';
        
        // ========================================
        // SISTEMA DE BACKUP AUTOM√ÅTICO (IndexedDB)
        // ========================================
        const BACKUP_DB_NAME = 'lpt-uno-backups';
        const BACKUP_DB_VERSION = 1;
        const BACKUP_STORE = 'sessions';
        const MAX_BACKUPS = 50; // M√°ximo de backups mantidos
        
        // Fun√ß√£o: Abrir banco de dados de backup
        function openBackupDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(BACKUP_DB_NAME, BACKUP_DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(BACKUP_STORE)) {
                        const store = db.createObjectStore(BACKUP_STORE, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('subfolder', 'subfolder', { unique: false });
                    }
                };
            });
        }
        
        // Fun√ß√£o: Salvar backup autom√°tico
        async function saveAutoBackup(data) {
            if (!data || data.trim().length === 0) return;
            
            try {
                const db = await openBackupDB();
                const transaction = db.transaction([BACKUP_STORE], 'readwrite');
                const store = transaction.objectStore(BACKUP_STORE);
                
                const prefs = loadPreferences();
                const backup = {
                    timestamp: new Date().toISOString(),
                    subfolder: prefs.subfolderName || 'default',
                    data: data,
                    size: data.length,
                    saved: false // Marca se foi salvo em arquivo
                };
                
                store.add(backup);
                
                // Limitar n√∫mero de backups
                const countRequest = store.count();
                countRequest.onsuccess = () => {
                    const count = countRequest.result;
                    if (count > MAX_BACKUPS) {
                        const index = store.index('timestamp');
                        const cursorRequest = index.openCursor();
                        let deleted = 0;
                        const toDelete = count - MAX_BACKUPS;
                        
                        cursorRequest.onsuccess = (e) => {
                            const cursor = e.target.result;
                            if (cursor && deleted < toDelete) {
                                cursor.delete();
                                deleted++;
                                cursor.continue();
                            }
                        };
                    }
                };
                
                console.log(`üíæ Backup autom√°tico salvo (${backup.size} bytes)`);
            } catch (e) {
                console.warn('Erro ao salvar backup:', e);
            }
        }
        
        // Fun√ß√£o: Listar backups
        async function listBackups() {
            try {
                const db = await openBackupDB();
                const transaction = db.transaction([BACKUP_STORE], 'readonly');
                const store = transaction.objectStore(BACKUP_STORE);
                const index = store.index('timestamp');
                
                return new Promise((resolve, reject) => {
                    const backups = [];
                    const request = index.openCursor(null, 'prev');
                    
                    request.onsuccess = (e) => {
                        const cursor = e.target.result;
                        if (cursor) {
                            backups.push({
                                id: cursor.value.id,
                                timestamp: cursor.value.timestamp,
                                subfolder: cursor.value.subfolder,
                                size: cursor.value.size,
                                saved: cursor.value.saved || false
                            });
                            cursor.continue();
                        } else {
                            resolve(backups);
                        }
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Erro ao listar backups:', e);
                return [];
            }
        }
        
        // Fun√ß√£o: Recuperar backup
        async function getBackup(id) {
            try {
                const db = await openBackupDB();
                const transaction = db.transaction([BACKUP_STORE], 'readonly');
                const store = transaction.objectStore(BACKUP_STORE);
                
                return new Promise((resolve, reject) => {
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Erro ao recuperar backup:', e);
                return null;
            }
        }
        
        // Fun√ß√£o: Marcar backup como salvo
        async function markBackupAsSaved(id) {
            try {
                const db = await openBackupDB();
                const transaction = db.transaction([BACKUP_STORE], 'readwrite');
                const store = transaction.objectStore(BACKUP_STORE);
                
                const backup = await getBackup(id);
                if (backup) {
                    backup.saved = true;
                    store.put(backup);
                }
            } catch (e) {
                console.warn('Erro ao marcar backup:', e);
            }
        }
        
        // Fun√ß√£o: Exportar todos os backups
        async function exportAllBackups() {
            try {
                const db = await openBackupDB();
                const transaction = db.transaction([BACKUP_STORE], 'readonly');
                const store = transaction.objectStore(BACKUP_STORE);
                
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const backups = request.result;
                        const exportData = {
                            version: '1.0',
                            exported: new Date().toISOString(),
                            count: backups.length,
                            backups: backups,
                            config: loadPreferences()
                        };
                        
                        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `LPT-UNO_BACKUP_${new Date().toISOString().slice(0,10)}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        showInfo(`üì¶ ${backups.length} backups exportados`);
                        resolve(true);
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('Erro ao exportar:', e);
                showError('‚ùå Erro ao exportar backups');
            }
        }
        
        // Auto-backup peri√≥dico
        let autoBackupTimer = null;
        function startAutoBackupSystem() {
            // Backup a cada 30 segundos
            autoBackupTimer = setInterval(() => {
                const text = output.textContent;
                if (text && text.trim().length > 0) {
                    saveAutoBackup(text);
                }
            }, 30000);
            
            // Backup antes de fechar p√°gina
            window.addEventListener('beforeunload', () => {
                const text = output.textContent;
                if (text && text.trim().length > 0) {
                    saveAutoBackup(text);
                }
            });
            
            console.log('üîÑ Sistema de backup autom√°tico ativado (30s)');
        }
        
        // Fun√ß√£o: Carregar prefer√™ncias
        function loadPreferences() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Erro ao carregar prefer√™ncias:', e);
            }
            // Prefer√™ncias padr√£o
            return {
                autoSave: true,
                autoPrint: false,
                viewMode: 'text',
                autoSaveTime: 10,
                language: 'en',
                saveFormat: 'txt',
                dataFolder: null,
                subfolderName: 'default'
            };
        }
        
        // Fun√ß√£o: Salvar prefer√™ncias
        async function savePreferences(prefs) {
            try {
                // Salvar no localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
                
                // Salvar tamb√©m em arquivo se temos acesso
                if (rootDirectoryHandle) {
                    await saveConfigToFile(prefs);
                }
            } catch (e) {
                console.error('Erro ao salvar prefer√™ncias:', e);
            }
        }
        
        // Fun√ß√£o: Aplicar tradu√ß√µes
        function applyTranslations(lang) {
            const t = translations[lang];
            currentLanguage = lang;
            
            // T√≠tulo da p√°gina
            document.title = t.title;
            
            // Header
            const h1 = document.querySelector('h1');
            const subtitle = document.querySelector('.subtitle');
            if (h1) h1.textContent = 'üñ®Ô∏è LPT-UNO';
            if (subtitle) subtitle.textContent = t.subtitle;
            
            // Bot√µes principais
            if (connectBtn) connectBtn.innerHTML = isConnected ? `üîå ${t.disconnect}` : `üîå ${t.connect}`;
            if (resetBtn) resetBtn.innerHTML = `üîÑ ${t.reset}`;
            if (clearBtn) clearBtn.innerHTML = `üóëÔ∏è ${t.clear}`;
            if (settingsBtn) settingsBtn.innerHTML = `‚öôÔ∏è ${t.settings}`;
            
            // Status
            if (statusText) statusText.textContent = isConnected ? t.connected : t.disconnected;
            
            // Bot√µes secund√°rios
            if (saveBtn) saveBtn.innerHTML = `üíæ ${t.saveNow}`;
            if (printBtn) printBtn.innerHTML = `üñ®Ô∏è ${t.printNow}`;
            if (autoSaveBtn) autoSaveBtn.innerHTML = `üíæ ${t.autoSave}`;
            
            if (autoPrintBtn) {
                const urlParams = new URLSearchParams(window.location.search);
                const isKiosk = urlParams.get('kiosk') === 'true';
                
                if (isKiosk) {
                    autoPrintBtn.innerHTML = `üñ®Ô∏è ${t.autoPrint}`;
                    autoPrintBtn.title = t.silentModeActive;
                    autoPrintBtn.style.color = ''; // Reset
                } else {
                    autoPrintBtn.innerHTML = `‚ö†Ô∏è ${t.autoPrint} ${t.manual}`;
                    autoPrintBtn.title = t.silentModeDisabled;
                    autoPrintBtn.style.color = 'yellow'; // Destaque visual
                }
            }
            
            // Estat√≠sticas
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels.length >= 3) {
                statLabels[0].textContent = t.bytesReceived;
                statLabels[1].textContent = t.rate;
                statLabels[2].textContent = t.uptime;
            }
            
            // Mensagem info
            if (infoMsg) {
                const infoText = infoMsg.textContent;
                if (infoText.includes('Clique') || infoText.includes('Click') || infoText.includes('Haga')) {
                    infoMsg.textContent = `‚ÑπÔ∏è ${t.infoMessage}`;
                }
            }
            
            // Modal
            const modalH2 = document.querySelector('.modal-header h2');
            if (modalH2) modalH2.textContent = `‚öôÔ∏è ${t.settingsTitle}`;
            
            const modalSectionH3 = document.querySelectorAll('.modal-section h3');
            if (modalSectionH3.length >= 3) {
                modalSectionH3[0].textContent = `üìä ${t.viewMode}`;
                modalSectionH3[1].textContent = `‚è±Ô∏è ${t.autoSaveTime}`;
                modalSectionH3[2].textContent = `üåê ${t.language}`;
            }
            
            const modalOptionSpans = document.querySelectorAll('.modal-option span');
            if (modalOptionSpans.length >= 3) {
                modalOptionSpans[0].textContent = `üìù ${t.textMode}`;
                modalOptionSpans[1].textContent = `üî¢ ${t.hexMode}`;
                modalOptionSpans[2].textContent = `üíª ${t.binaryMode}`;
            }
            
            const autoSaveTimeLabel = document.querySelector('label[for="autoSaveTime"]');
            if (autoSaveTimeLabel) autoSaveTimeLabel.textContent = `‚è∞ ${t.inactivity}`;
            
            const langSectionTitle = document.getElementById('langSectionTitle');
            if (langSectionTitle) langSectionTitle.textContent = `üåê ${t.language}`;
            
            const langLabel = document.getElementById('langLabel');
            if (langLabel) langLabel.textContent = `üåç ${t.selectLanguage}`;
            
            // Bot√£o configurar email
            const openEmailConfig = document.getElementById('openEmailConfig');
            if (openEmailConfig) openEmailConfig.textContent = `üìß ${t.configureEmail}`;
            
            // Modal de email
            const emailConfigTitle = document.getElementById('emailConfigTitle');
            if (emailConfigTitle) emailConfigTitle.textContent = `üìß ${t.emailConfigTitle}`;
            
            const smtpServerNote = document.getElementById('smtpServerNote');
            if (smtpServerNote) smtpServerNote.innerHTML = t.smtpServerNote;
            
            const smtpPortNote = document.getElementById('smtpPortNote');
            if (smtpPortNote) smtpPortNote.innerHTML = t.smtpPortNote;
            
            const smtpPasswordNote = document.getElementById('smtpPasswordNote');
            if (smtpPasswordNote) smtpPasswordNote.innerHTML = t.smtpPasswordNote;
            
            const senderNameLabel = document.getElementById('senderNameLabel');
            if (senderNameLabel) senderNameLabel.textContent = t.senderName;
            
            const senderEmailLabel = document.getElementById('senderEmailLabel');
            if (senderEmailLabel) senderEmailLabel.textContent = t.senderEmail;
            
            const smtpServerLabel = document.getElementById('smtpServerLabel');
            if (smtpServerLabel) smtpServerLabel.textContent = t.smtpServer;
            
            const smtpPortLabel = document.getElementById('smtpPortLabel');
            if (smtpPortLabel) smtpPortLabel.textContent = t.smtpPort;
            
            const smtpSecureLabel = document.getElementById('smtpSecureLabel');
            if (smtpSecureLabel) smtpSecureLabel.textContent = t.smtpSecure;
            
            const smtpUserLabel = document.getElementById('smtpUserLabel');
            if (smtpUserLabel) smtpUserLabel.textContent = t.smtpUser;
            
            const smtpPasswordLabel = document.getElementById('smtpPasswordLabel');
            if (smtpPasswordLabel) smtpPasswordLabel.textContent = t.smtpPassword;
            
            const saveEmailConfig = document.getElementById('saveEmailConfig');
            if (saveEmailConfig) saveEmailConfig.textContent = `üíæ ${t.saveEmailConfig}`;
            
            const testEmailConfig = document.getElementById('testEmailConfig');
            if (testEmailConfig) testEmailConfig.textContent = `‚úÖ ${t.testEmailConfig}`;
            
            // Bot√£o destinat√°rios
            const recipientsBtn = document.getElementById('recipientsBtn');
            if (recipientsBtn) recipientsBtn.innerHTML = `üìß ${t.configureRecipients}`;
            
            // Modal de destinat√°rios
            const recipientsTitle = document.getElementById('recipientsTitle');
            if (recipientsTitle) recipientsTitle.textContent = `üìß ${t.recipientsTitle}`;
            
            const saveRecipients = document.getElementById('saveRecipients');
            if (saveRecipients) saveRecipients.textContent = `üíæ ${t.saveRecipients}`;
            
            // Atualizar placeholders dos destinat√°rios
            updateRecipientPlaceholders();
            
            // Atualizar op√ß√µes de tempo
            if (autoSaveTimeSelect) {
                const timeOptions = autoSaveTimeSelect.querySelectorAll('option');
                if (timeOptions.length >= 6) {
                    timeOptions[0].textContent = `10 ${t.seconds}`;
                    timeOptions[1].textContent = `15 ${t.seconds}`;
                    timeOptions[2].textContent = `30 ${t.seconds}`;
                    timeOptions[3].textContent = `1 ${t.minute}`;
                    timeOptions[4].textContent = `2 ${t.minutes}`;
                    timeOptions[5].textContent = `5 ${t.minutes}`;
                }
            }
            
            // Footer
            const footerPs = document.querySelectorAll('footer p');
            if (footerPs.length >= 2) {
                footerPs[0].innerHTML = `<strong>LPT-UNO</strong> | ${t.footer1}`;
                footerPs[1].innerHTML = footerPs[1].innerHTML.replace(
                    /Requer.*Opera|Requires.*Opera|Requiere.*Opera/,
                    t.footer2
                );
            }
        }
        
        // Elementos DOM
        const connectBtn = document.getElementById('connectBtn');
        const clearBtn = document.getElementById('clearBtn');
        const saveBtn = document.getElementById('saveBtn');
        const resetBtn = document.getElementById('resetBtn');
        const output = document.getElementById('output');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const byteCountEl = document.getElementById('byteCount');
        const dataRateEl = document.getElementById('dataRate');
        const uptimeEl = document.getElementById('uptime');
        const errorMsg = document.getElementById('errorMsg');
        const infoMsg = document.getElementById('infoMsg');
        const autoSaveBtn = document.getElementById('autoSaveBtn');
        const autoPrintBtn = document.getElementById('autoPrintBtn');
        const printBtn = document.getElementById('printBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModal = document.getElementById('closeModal');
        const viewOptions = document.querySelectorAll('.modal-option');
        const autoSaveTimeSelect = document.getElementById('autoSaveTime');
        const languageSelect = document.getElementById('languageSelect');
        const openEmailConfig = document.getElementById('openEmailConfig');
        const emailConfigModal = document.getElementById('emailConfigModal');
        const closeEmailModal = document.getElementById('closeEmailModal');
        const emailForm = document.getElementById('emailForm');
        const testEmailConfig = document.getElementById('testEmailConfig');
        const recipientsBtn = document.getElementById('recipientsBtn');
        const recipientsModal = document.getElementById('recipientsModal');
        const closeRecipientsModal = document.getElementById('closeRecipientsModal');
        const recipientsContainer = document.getElementById('recipientsContainer');
        const saveRecipientsBtn = document.getElementById('saveRecipients');
        
        // Verificar suporte Web Serial API
        if (!('serial' in navigator)) {
            showError('Web Serial API n√£o suportada. Use Chrome, Edge ou Opera.');
            connectBtn.disabled = true;
        }
        
        // Carregar prefer√™ncias salvas
        const preferences = loadPreferences();
        
        // Aplicar idioma salvo (ser√° chamado depois)
        currentLanguage = preferences.language || 'pt';
        if (languageSelect) {
            languageSelect.value = currentLanguage;
        }
        
        // Tentar conex√£o autom√°tica ao Arduino
        setTimeout(async () => {
            const autoConnect = localStorage.getItem('lptUnoAutoConnect');
            if (autoConnect === 'true') {
                try {
                    // Obter portas j√° autorizadas
                    const ports = await navigator.serial.getPorts();
                    if (ports.length > 0) {
                        port = ports[0]; // Usar a primeira porta autorizada
                        await connect(true);
                        showInfo('‚úÖ Conectado automaticamente ao Arduino!');
                    }
                } catch (error) {
                    console.log('Auto-conex√£o n√£o dispon√≠vel:', error);
                }
            }
        }, 1000);
        
        // Aplicar prefer√™ncias salvas
        if (preferences.autoSave) {
            autoSaveBtn.classList.add('active');
            autoPrintBtn.disabled = false;
        } else {
            autoSaveBtn.classList.remove('active');
            autoPrintBtn.disabled = true;
        }
        
        if (preferences.autoPrint) {
            autoPrintBtn.classList.add('active');
        } else {
            autoPrintBtn.classList.remove('active');
        }
        
        // Aplicar modo de visualiza√ß√£o salvo
        currentView = preferences.viewMode;
        viewOptions.forEach(option => {
            const radio = option.querySelector('input[type="radio"]');
            if (option.dataset.view === preferences.viewMode) {
                option.classList.add('selected');
                radio.checked = true;
            } else {
                option.classList.remove('selected');
                radio.checked = false;
            }
        });
        if (currentView === 'hex') {
            output.className = 'hex-view';
        }
        
        // Aplicar tempo de auto-salvar
        if (autoSaveTimeSelect && preferences.autoSaveTime) {
            autoSaveTimeSelect.value = preferences.autoSaveTime;
        }
        
        // ========================================
        // DETEC√á√ÉO AUTOM√ÅTICA
        // ========================================
        
        // Fun√ß√£o: Auto-conectar se poss√≠vel (ao carregar ou reconectar)
        async function tryAutoConnect() {
            if (!('serial' in navigator)) return;
            const t = translations[currentLanguage];
            
            try {
                // Obter portas j√° autorizadas
                const ports = await navigator.serial.getPorts();
                if (ports.length > 0) {
                    console.log(`üîå Detec√ß√£o autom√°tica: ${ports.length} porta(s) encontrada(s). Tentando conectar...`);
                    showInfo(t.autoDetectFound);
                    
                    // Tentar conectar na primeira porta dispon√≠vel
                    // Nota: Idealmente verificar√≠amos VID/PID, mas getPorts() retorna objetos SerialPort opacos
                    // que podemos comparar se tiv√©ssemos salvo o info, mas conectar no primeiro √© seguro se o usu√°rio s√≥ usa um Arduino.
                    port = ports[0];
                    await connectToPort(port);
                } else {
                    console.log('üîå Detec√ß√£o autom√°tica: Nenhuma porta autorizada encontrada.');
                }
            } catch (err) {
                console.error('Erro na detec√ß√£o autom√°tica:', err);
            }
        }
        
        // Fun√ß√£o: Conectar/Desconectar Arduino
        connectBtn.addEventListener('click', async () => {
            if (isConnected) {
                // Usu√°rio pediu para desconectar explicitamente: n√£o reconectar automaticamente
                autoReconnectEnabled = false;
                await disconnect();
            } else {
                autoReconnectEnabled = true;
                await connect();
            }
        });
        
        // Fun√ß√£o auxiliar para conectar a uma porta espec√≠fica
        async function connectToPort(serialPort) {
            port = serialPort;
            await connect(true);
        }
        
        async function connect(autoConnect = false) {
            const t = translations[currentLanguage];
            try {
                // Solicitar porta serial somente se n√£o estamos em auto-connect
                if (!autoConnect) {
                    port = await navigator.serial.requestPort();
                }
                
                if (!port) return;
                
                await port.open({ baudRate: 115200 });
                
                isConnected = true;
                updateStatus(true);
                infoMsg.style.display = 'none';
                startTime = Date.now();
                
                // Monitorar sinais: Se houver desconex√£o, tentar reconectar
                navigator.serial.addEventListener('disconnect', handleDisconnectEvent);
                
                // Configurar leitor com encoding UTF-8 para suportar caracteres portugueses
                const decoder = new TextDecoderStream('utf-8');
                const inputDone = port.readable.pipeTo(decoder.writable);
                const inputStream = decoder.readable;
                reader = inputStream.getReader();
                
                // Configurar escritor
                const encoder = new TextEncoderStream();
                const outputDone = encoder.readable.pipeTo(port.writable);
                writer = encoder.writable.getWriter();
                
                // Resetar tentativas de reconex√£o
                reconnectAttempts = 0;
                
                // Solicitar identifica√ß√£o e vers√£o do firmware
                writer.write('I'); // Comando de identifica√ß√£o
                setTimeout(() => writer.write('V'), 100);
                
                // Salvar que conect√°mos com sucesso
                localStorage.setItem('lptUnoAutoConnect', 'true');
                
                // Limpeza inicial do buffer visual ap√≥s 3 segundos
                // Isto remove o banner de inicializa√ß√£o sem afetar o buffer interno de parsing
                setTimeout(() => {
                    output.textContent = '';
                    byteCount = 0;
                    byteCountEl.textContent = '0';
                    pendingData = ''; // Limpar dados pendentes para que o banner n√£o seja salvo
                    showInfo(t.bufferCleared);
                }, 3000);
                
                // Iniciar leitura de dados
                readData();
                
                // Iniciar atualiza√ß√£o de estat√≠sticas
                setInterval(updateStats, 1000);
                
            } catch (error) {
                console.error("Connection error:", error);
                showError(`${t.errorConnect} ${error.message}`);
                
                // Se falhou no auto-connect, tentar novamente?
                if (autoConnect && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    scheduleReconnect();
                }
            }
        }
        
        // Event listener para desconex√£o do dispositivo (cabo removido)
        function handleDisconnectEvent(event) {
            console.log('Evento de desconex√£o detectado:', event);
            if (event.target === port || event.port === port) {
                console.log('A porta ativa foi desconectada.');
                if (autoReconnectEnabled) {
                    scheduleReconnect();
                }
            }
        }
        
        function scheduleReconnect() {
            const t = translations[currentLanguage];
            if (reconnectTimer) clearTimeout(reconnectTimer);
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                showError(t.reconnectFailed);
                reconnectAttempts = 0;
                return;
            }
            
            reconnectAttempts++;
            const delay = 2000; // 2 segundos
            
            showInfo(`${t.connectionLost} ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} (2s)...`);
            console.log(`Tentando reconectar em ${delay}ms...`);
            
            reconnectTimer = setTimeout(() => {
                tryAutoConnect();
            }, delay);
        }
        
        async function disconnect() {
            try {
                // Remover listener de desconex√£o para n√£o reconectar acidentalmente
                navigator.serial.removeEventListener('disconnect', handleDisconnectEvent);
                
                if (reader) {
                    await reader.cancel();
                    reader = null;
                }
                if (writer) {
                    await writer.close();
                    writer = null;
                }
                if (port) {
                    await port.close();
                    port = null;
                }
                
                isConnected = false;
                updateStatus(false);
                
                // N√£o reconectar automaticamente na pr√≥xima vez
                localStorage.removeItem('lptUnoAutoConnect');
                
            } catch (error) {
                showError('Erro ao desconectar: ' + error.message);
            }
        }
        
        // Buffer para parsing de metadados
        let metadataBuffer = '';

        // Fun√ß√£o: Ler dados do Arduino
        async function readData() {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // Acumular para parsing de vers√£o (robusto contra pacotes fragmentados)
                    metadataBuffer += value;
                    // Limitar tamanho do buffer de metadados para n√£o crescer infinitamente
                    if (metadataBuffer.length > 200) {
                         // Manter apenas os √∫ltimos 200 chars se n√£o encontrarmos quebras de linha logo
                         // Mas o ideal √© processar linha a linha.
                         const lastNewline = metadataBuffer.lastIndexOf('\n');
                         if (lastNewline !== -1) {
                             metadataBuffer = metadataBuffer.substring(lastNewline + 1);
                         } 
                    }

                    // Tentar extrair vers√£o do buffer acumulado
                    const firmwareRegex = /Firmware: v([\d.]+)/;
                    const buildRegex = /Build: ([\w\s:]+)/;
                    
                    const fwMatch = metadataBuffer.match(firmwareRegex);
                    if (fwMatch) {
                        firmwareVersion = fwMatch[1];
                        updateFirmwareDisplay();
                    }

                    const buildMatch = metadataBuffer.match(buildRegex);
                    if (buildMatch) {
                        firmwareBuild = buildMatch[1].trim();
                        updateFirmwareDisplay();
                    }
                    
                    // Processar dados recebidos (Exibi√ß√£o imediata)
                    for (let i = 0; i < value.length; i++) {
                        const byte = value.charCodeAt(i);
                        
                        byteCount++;
                        displayByte(byte);
                        
                        // Acumular dados para auto-save/print
                        if (byte >= 32 && byte <= 126) {
                            pendingData += String.fromCharCode(byte);
                        } else if (byte === 10 || byte === 13) {
                            pendingData += String.fromCharCode(byte);
                        }
                    }
                    
                    // Resetar timer de inatividade
                    resetInactivityTimer();
                }
            } catch (error) {
                if (isConnected) {
                    showError('Erro na leitura: ' + error.message);
                    await disconnect();
                }
            }
        }
        
        // Fun√ß√£o: Exibir byte conforme modo de visualiza√ß√£o
        function displayByte(byte) {
            let text = '';
            
            switch (currentView) {
                case 'text':
                    // Modo texto (ASCII)
                    if (byte >= 32 && byte <= 126) {
                        text = String.fromCharCode(byte);
                    } else if (byte === 10) {
                        text = '\n';
                    } else if (byte === 13) {
                        text = '\r';
                    } else if (byte === 9) {
                        text = '\t';
                    } else {
                        text = `[${byte.toString(16).padStart(2, '0')}]`;
                    }
                    break;
                    
                case 'hex':
                    // Modo hexadecimal
                    text = byte.toString(16).padStart(2, '0').toUpperCase() + ' ';
                    if (byteCount % 16 === 0) text += '\n';
                    break;
                    
                case 'binary':
                    // Modo bin√°rio
                    text = byte.toString(2).padStart(8, '0') + ' ';
                    if (byteCount % 8 === 0) text += '\n';
                    break;
            }
            
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }
        
        // Fun√ß√£o: Atualizar exibi√ß√£o de firmware
        function updateFirmwareDisplay() {
            const firmwareInfo = document.getElementById('firmwareInfo');
            if (firmwareInfo) {
                firmwareInfo.innerHTML = `Web Interface v1.0 | Build: 2026-01-25<br>Arduino Firmware: v${firmwareVersion} | Build: ${firmwareBuild}`;
            }
        }
        
        // Fun√ß√£o: Atualizar status
        function updateStatus(connected) {
            const t = translations[currentLanguage];
            if (connected) {
                statusIndicator.classList.add('connected');
                statusText.textContent = t.connected;
                connectBtn.textContent = `üîå ${t.disconnect}`;
                connectBtn.classList.add('connected');
            } else {
                statusIndicator.classList.remove('connected');
                statusText.textContent = t.disconnected;
                connectBtn.textContent = `üîå ${t.connect}`;
                connectBtn.classList.remove('connected');
            }
        }
        
        // Fun√ß√£o: Atualizar estat√≠sticas
        function updateStats() {
            if (!isConnected) return;
            
            // Atualizar contador de bytes
            byteCountEl.textContent = byteCount.toLocaleString();
            
            // Calcular taxa de dados
            const bytesPerSecond = byteCount - lastByteCount;
            lastByteCount = byteCount;
            dataRateEl.textContent = bytesPerSecond + ' B/s';
            
            // Atualizar tempo ativo
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                uptimeEl.textContent = `${hours}:${minutes}:${seconds}`;
            }
        }
        
        // Fun√ß√£o: Limpar output
        clearBtn.addEventListener('click', () => {
            output.textContent = '';
            errorMsg.style.display = 'none';
        });
        
        // Fun√ß√£o: Salvar output
        saveBtn.addEventListener('click', async () => {
            const text = output.textContent;
            if (!text || text.trim().length === 0) {
                showError('Nenhum dado para salvar');
                return;
            }
            
            const prefs = loadPreferences();
            const format = prefs.saveFormat || 'txt';
            const timestamp = generateTimestamp();
            
            await saveToFile(text, timestamp, format);
        });
        
        // Fun√ß√£o: Salvar arquivo no formato escolhido
        async function saveToFile(text, timestamp, format) {
            try {
                // Obter prefixo do arquivo (se configurado)
                const prefs = loadPreferences();
                const filePrefix = prefs.subfolderName || 'lpt-uno';
                
                // Sanitizar prefixo (remover caracteres inv√°lidos)
                const sanitizedPrefix = filePrefix.replace(/[<>:"\/\\|?*]/g, '_');
                
                let blob, filename, mimeType;
                const baseFilename = `${sanitizedPrefix}_${timestamp}`;
                
                switch(format) {
                    case 'csv':
                        // Converter texto para CSV (uma linha por byte/caractere)
                        const csvContent = 'Timestamp,Character,ASCII,Hex\\n' + 
                            text.split('').map((char, i) => {
                                const ascii = char.charCodeAt(0);
                                const hex = ascii.toString(16).toUpperCase().padStart(2, '0');
                                return `${timestamp},"${char.replace(/"/g, '""')}",${ascii},0x${hex}`;
                            }).join('\\n');
                        blob = new Blob([csvContent], { type: 'text/csv; charset=utf-8' });
                        filename = `${baseFilename}.csv`;
                        mimeType = 'text/csv';
                        break;
                        
                    case 'pdf':
                        // Gerar PDF simples usando jsPDF (inline)
                        const pdfContent = generateSimplePDF(text, timestamp);
                        blob = new Blob([pdfContent], { type: 'application/pdf' });
                        filename = `${baseFilename}.pdf`;
                        mimeType = 'application/pdf';
                        break;
                        
                    case 'txt':
                    default:
                        blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
                        filename = `${baseFilename}.txt`;
                        mimeType = 'text/plain';
                        break;
                }
                
                // Download do arquivo
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showInfo(`üíæ Arquivo ${filename} salvo na pasta Downloads!`);
                
            } catch (error) {
                console.error('Erro ao salvar arquivo:', error);
                showError('‚ùå Erro ao salvar arquivo');
            }
        }
        
        // Fun√ß√£o: Gerar PDF simples (b√°sico, sem biblioteca externa)
        function generateSimplePDF(text, timestamp) {
            // PDF b√°sico em formato texto (para funcionar sem bibliotecas)
            const pdfHeader = `%PDF-1.4\n1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n3 0 obj\n<< /Type /Page /Parent 2 0 R /Resources 4 0 R /MediaBox [0 0 612 792] /Contents 5 0 R >>\nendobj\n4 0 obj\n<< /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Courier >> >> >>\nendobj\n5 0 obj\n<< /Length ${text.length + 100} >>\nstream\nBT\n/F1 10 Tf\n50 750 Td\n(LPT-UNO Output - ${timestamp}) Tj\n0 -15 Td\n`;
            
            const pdfContent = text.split('\n').slice(0, 50).map(line => 
                `(${line.replace(/[()\\]/g, '\\$&').substring(0, 80)}) Tj\n0 -12 Td\n`
            ).join('');
            
            const pdfFooter = `ET\nendstream\nendobj\nxref\n0 6\n0000000000 65535 f \n0000000009 00000 n \n0000000058 00000 n \n0000000115 00000 n \n0000000214 00000 n \n0000000304 00000 n \ntrailer\n<< /Size 6 /Root 1 0 R >>\nstartxref\n${400 + text.length}\n%%EOF`;
            
            return pdfHeader + pdfContent + pdfFooter;
        }
        
        // Fun√ß√£o: Imprimir agora
        printBtn.addEventListener('click', () => {
            const text = output.textContent;
            if (!text || text.trim().length === 0) {
                showError('Nenhum dado para imprimir');
                return;
            }
            printData(text);
        });
        
        // Fun√ß√£o: Toggle Auto-salvar
        autoSaveBtn.addEventListener('click', () => {
            autoSaveBtn.classList.toggle('active');
            const isActive = autoSaveBtn.classList.contains('active');
            showInfo(isActive ? '‚úÖ Auto-salvar ativado' : '‚õî Auto-salvar desativado');
            
            // Se auto-salvar for desativado, desativar tamb√©m auto-imprimir
            if (!isActive && autoPrintBtn.classList.contains('active')) {
                autoPrintBtn.classList.remove('active');
                autoPrintBtn.disabled = true;
                const prefs = loadPreferences();
                prefs.autoPrint = false;
                savePreferences(prefs);
            } else {
                autoPrintBtn.disabled = !isActive;
            }
            
            // Salvar prefer√™ncia
            const prefs = loadPreferences();
            prefs.autoSave = isActive;
            savePreferences(prefs);
        });
        
        // Fun√ß√£o: Toggle Auto-imprimir
        autoPrintBtn.addEventListener('click', () => {
            // S√≥ permitir ativar se auto-salvar estiver ativo
            if (!autoSaveBtn.classList.contains('active')) {
                showError('‚ö†Ô∏è Auto-imprimir requer Auto-salvar ativado!');
                return;
            }
            
            autoPrintBtn.classList.toggle('active');
            const isActive = autoPrintBtn.classList.contains('active');
            showInfo(isActive ? '‚úÖ Auto-imprimir ativado' : '‚õî Auto-imprimir desativado');
            
            // Salvar prefer√™ncia
            const prefs = loadPreferences();
            prefs.autoPrint = isActive;
            savePreferences(prefs);
        });
        
        // Fun√ß√£o: Enviar comando Reset ao Arduino
        resetBtn.addEventListener('click', async () => {
            if (isConnected && writer) {
                try {
                    await writer.write('R');
                    showInfo('Comando Reset enviado ao Arduino');
                } catch (error) {
                    showError('Erro ao enviar comando: ' + error.message);
                }
            } else {
                showError('Arduino n√£o conectado');
            }
        });
        
        // Fun√ß√£o: Abrir modal de defini√ß√µes
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('show');
            
            // Carregar prefer√™ncias atuais
            const prefs = loadPreferences();
            
            // Carregar valores se necess√°rio
            const autoSaveTimeSelect = document.getElementById('autoSaveTime');
            if (autoSaveTimeSelect) {
                autoSaveTimeSelect.value = prefs.autoSaveTime || 10;
            }
        });
        
        // Fun√ß√£o: Fechar modal
        closeModal.addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });
        
        // Fechar modal ao clicar fora
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
            }
        });
        
        // Fun√ß√£o: Alternar modo de visualiza√ß√£o no modal
        viewOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Remover sele√ß√£o anterior
                viewOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Adicionar sele√ß√£o atual
                option.classList.add('selected');
                const radio = option.querySelector('input[type="radio"]');
                radio.checked = true;
                
                // Atualizar modo
                currentView = option.dataset.view;
                
                // Atualizar classe CSS do output
                output.className = currentView === 'hex' ? 'hex-view' : '';
                
                // Limpar output ao mudar visualiza√ß√£o
                output.textContent = '';
                
                // Salvar prefer√™ncia
                const prefs = loadPreferences();
                prefs.viewMode = currentView;
                savePreferences(prefs);
                
                showInfo(`Modo de visualiza√ß√£o: ${currentView === 'text' ? 'Texto' : currentView === 'hex' ? 'Hexadecimal' : 'Bin√°rio'}`);
            });
        });
        
        // Fun√ß√£o: Alterar tempo de auto-salvar
        autoSaveTimeSelect.addEventListener('change', () => {
            const selectedTime = parseInt(autoSaveTimeSelect.value);
            const prefs = loadPreferences();
            prefs.autoSaveTime = selectedTime;
            savePreferences(prefs);
            
            const timeText = selectedTime >= 60 ? 
                `${selectedTime / 60} minuto${selectedTime > 60 ? 's' : ''}` : 
                `${selectedTime} segundos`;
            showInfo(`‚è±Ô∏è ${translations[currentLanguage].autoSaveTimeChanged} ${timeText}`);
        });
        
        // Fun√ß√£o: Alterar idioma
        if (languageSelect) {
            languageSelect.addEventListener('change', () => {
                const selectedLang = languageSelect.value;
                const prefs = loadPreferences();
                prefs.language = selectedLang;
                savePreferences(prefs);
                
                applyTranslations(selectedLang);
                
                const langNames = { pt: 'Portugu√™s', en: 'English', es: 'Espa√±ol' };
                showInfo(`üåê ${translations[selectedLang].languageChanged} ${langNames[selectedLang]}`);
            });
        }
        
        // Fun√ß√£o: Alterar formato de salvamento
        const saveFormatRadios = document.querySelectorAll('input[name="saveFormat"]');
        saveFormatRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const format = e.target.value;
                const prefs = loadPreferences();
                prefs.saveFormat = format;
                savePreferences(prefs);
                
                // Atualizar visual
                document.querySelectorAll('[data-format]').forEach(el => el.classList.remove('selected'));
                e.target.closest('[data-format]').classList.add('selected');
                
                const formatNames = { txt: 'TXT', csv: 'CSV', pdf: 'PDF' };
                showInfo(`üíæ Formato alterado para: ${formatNames[format]}`);
            });
        });
        
        // Fun√ß√£o: Salvar nome do arquivo (prefixo)
        const subfolderNameInput = document.getElementById('subfolderNameInput');
        if (subfolderNameInput) {
            // Carregar valor salvo
            const prefs = loadPreferences();
            subfolderNameInput.value = prefs.subfolderName || '';
            
            // Salvar quando o usu√°rio digitar (com debounce)
            let debounceTimer;
            subfolderNameInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const value = e.target.value.trim();
                    const prefs = loadPreferences();
                    prefs.subfolderName = value || 'lpt-uno';
                    savePreferences(prefs);
                    
                    if (value) {
                        showInfo(`üìù Prefixo do arquivo: ${value}_[timestamp].[ext]`);
                    }
                }, 500); // 500ms debounce
            });
        }
        
        // Abrir modal de configura√ß√£o de email
        if (openEmailConfig) {
            openEmailConfig.addEventListener('click', () => {
                if (emailConfigModal) {
                    emailConfigModal.classList.add('show');
                    loadEmailConfig();
                }
            });
        }
        
        // ========================================
        // ASSISTENTE DE CONFIGURA√á√ÉO AUTOM√ÅTICA
        // ========================================
        const autoConfigScriptBtn = document.getElementById('autoConfigScriptBtn');
        const wizardSteps = document.getElementById('wizardSteps');
        const validateUrlBtn = document.getElementById('validateUrlBtn');
        const wizardUrlInput = document.getElementById('wizardUrlInput');
        
        if (autoConfigScriptBtn) {
            autoConfigScriptBtn.addEventListener('click', async () => {
                // C√≥digo do Google Apps Script (embutido)
                const scriptCode = `// ========================================
// Google Apps Script - LPT-UNO Email Sender
// ========================================
// Este script permite enviar emails do navegador usando sua conta Gmail
// GRATUITO e ILIMITADO!
//
// Vers√£o: 1.0 | Data: 2026-01-25
// ========================================

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const to = data.to;
    const toName = data.toName;
    const fromName = data.fromName;
    const subject = data.subject;
    const body = data.body;
    
    if (!to || !subject || !body) {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          message: 'Campos obrigat√≥rios faltando (to, subject, body)'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    GmailApp.sendEmail(to, subject, body, {
      name: fromName || 'LPT-UNO',
      noReply: false
    });
    
    Logger.log('‚úÖ Email enviado para: ' + to);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'Email enviado com sucesso!',
        to: to
      }))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('‚ùå Erro: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: 'Erro ao enviar email: ' + error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput('LPT-UNO Email Sender est√° rodando! ‚úÖ')
    .setMimeType(ContentService.MimeType.TEXT);
}`;
                
                try {
                    // Passo 1: Copiar script automaticamente
                    await navigator.clipboard.writeText(scriptCode);
                    
                    // Mostrar wizard
                    wizardSteps.style.display = 'block';
                    autoConfigScriptBtn.style.display = 'none';
                    
                    // Mostrar Passo 1
                    document.getElementById('step1').style.display = 'block';
                    showInfo('‚úÖ Script copiado! Abrindo Google Apps Script em 3 segundos...');
                    
                    // Contagem regressiva
                    let countdown = 3;
                    const countdownEl = document.getElementById('countdown');
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdownEl) countdownEl.textContent = countdown;
                        if (countdown === 0) {
                            clearInterval(countdownInterval);
                        }
                    }, 1000);
                    
                    // Passo 2: Abrir Google Apps Script ap√≥s 3 segundos
                    setTimeout(() => {
                        const appsScriptWindow = window.open('https://script.google.com/home/start', '_blank', 'width=1200,height=800');
                        
                        // Mostrar Passo 2
                        document.getElementById('step1').style.display = 'none';
                        document.getElementById('step2').style.display = 'block';
                        
                        // Aguardar alguns segundos e mostrar Passo 3
                        setTimeout(() => {
                            document.getElementById('step2').style.display = 'none';
                            document.getElementById('step3').style.display = 'block';
                            showInfo('üìù Siga as instru√ß√µes para implantar o script!');
                            
                            // Mostrar Passo 4 ap√≥s mais tempo
                            setTimeout(() => {
                                document.getElementById('step3').style.display = 'none';
                                document.getElementById('step4').style.display = 'block';
                                showInfo('üéØ Quase l√°! Cole a URL gerada e clique em Validar!');
                                wizardUrlInput.focus();
                            }, 30000); // 30 segundos para implantar
                            
                        }, 10000); // 10 segundos para colar c√≥digo
                        
                    }, 3000);
                    
                } catch (error) {
                    showError('‚ùå Erro ao copiar script: ' + error.message);
                    
                    // Fallback para navegadores mais antigos
                    const textarea = document.createElement('textarea');
                    textarea.value = scriptCode;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    showInfo('‚úÖ Script copiado (modo compatibilidade)!');
                    wizardSteps.style.display = 'block';
                    autoConfigScriptBtn.style.display = 'none';
                    document.getElementById('step1').style.display = 'block';
                }
            });
        }
        
        // Validar e salvar URL automaticamente
        if (validateUrlBtn) {
            validateUrlBtn.addEventListener('click', () => {
                const url = wizardUrlInput.value.trim();
                
                // Validar formato da URL
                const appsScriptRegex = /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec$/;
                
                if (!url) {
                    showError('‚ùå Por favor, cole a URL do Google Apps Script!');
                    wizardUrlInput.focus();
                    return;
                }
                
                if (!appsScriptRegex.test(url)) {
                    showError('‚ùå URL inv√°lida! Formato esperado: https://script.google.com/macros/s/SEU_ID/exec');
                    wizardUrlInput.focus();
                    return;
                }
                
                // URL v√°lida! Salvar automaticamente
                document.getElementById('appsScriptUrl').value = url;
                
                // Salvar configura√ß√£o
                const senderName = document.getElementById('senderName').value || 'LPT-UNO';
                const emailConfig = {
                    appsScriptUrl: url,
                    senderName: senderName
                };
                localStorage.setItem('emailConfig', JSON.stringify(emailConfig));
                
                // Feedback de sucesso
                showInfo('üéâ Configura√ß√£o salva com sucesso!');
                showInfo('‚úÖ Voc√™ pode agora fechar este modal e testar o envio de emails!');
                
                // Resetar wizard
                setTimeout(() => {
                    wizardSteps.style.display = 'none';
                    autoConfigScriptBtn.style.display = 'block';
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'none';
                    document.getElementById('step4').style.display = 'none';
                    wizardUrlInput.value = '';
                    
                    // Fechar modal ap√≥s sucesso
                    setTimeout(() => {
                        if (emailConfigModal) {
                            emailConfigModal.classList.remove('show');
                        }
                    }, 2000);
                }, 2000);
            });
        }
        
        // Fechar modal de email
        if (closeEmailModal) {
            closeEmailModal.addEventListener('click', () => {
                if (emailConfigModal) emailConfigModal.classList.remove('show');
            });
        }
        
        // Fechar modal de email ao clicar fora
        if (emailConfigModal) {
            emailConfigModal.addEventListener('click', (e) => {
                if (e.target === emailConfigModal) {
                    emailConfigModal.classList.remove('show');
                }
            });
        }
        
        // Salvar configura√ß√µes de email
        if (emailForm) {
            emailForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveEmailConfig();
            });
        }
        
        // Testar configura√ß√£o de email
        if (testEmailConfig) {
            testEmailConfig.addEventListener('click', () => {
                testEmailConfiguration();
            });
        }
        
        // Fun√ß√£o: Testar configura√ß√£o de email
        function testEmailConfiguration() {
            const t = translations[currentLanguage];
            
            // Validar campo obrigat√≥rio
            const appsScriptUrl = document.getElementById('appsScriptUrl').value.trim();
            const senderName = document.getElementById('senderName').value.trim();
            
            if (!appsScriptUrl) {
                showError(t.fillAllFields || 'Preencha a URL do Google Apps Script!');
                return;
            }
            
            // Validar formato da URL do Apps Script
            const appsScriptRegex = /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec$/;
            if (!appsScriptRegex.test(appsScriptUrl)) {
                showError('‚ùå URL inv√°lida! Formato esperado: https://script.google.com/macros/s/SEU_ID/exec');
                return;
            }
            
            showInfo(`üìß ${t.testingEmail || 'Testando configura√ß√£o de email...'}`);
            
            // Enviar email de teste real via Google Apps Script
            const testPayload = {
                to: 'teste@exemplo.com',
                toName: 'Destinat√°rio Teste',
                fromName: senderName || 'LPT-UNO',
                subject: 'üß™ Teste LPT-UNO - Email Autom√°tico',
                body: `Este √© um email de teste enviado em ${new Date().toLocaleString('pt-PT')}.\n\nSe voc√™ receber esta mensagem, sua configura√ß√£o est√° funcionando!\n\n---\nLPT-UNO Email System\nGoogle Apps Script Integration`
            };
            
            fetch(appsScriptUrl, {
                method: 'POST',
                mode: 'no-cors', // Necess√°rio para Apps Script
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testPayload)
            })
            .then(() => {
                // Com mode: 'no-cors', n√£o conseguimos ler a resposta
                // Mas se n√£o houver erro, assume-se que funcionou
                showInfo(`‚úÖ ${t.emailTestSuccess || 'Teste enviado! Verifique sua caixa de entrada (teste@exemplo.com).'}`);
                showInfo(`‚ö†Ô∏è ${t.emailTestNote || 'Nota: Com Google Apps Script, voc√™ ver√° o email sendo enviado. Verifique seus Enviados no Gmail.'}`);
            })
            .catch(error => {
                console.error('Erro ao testar email:', error);
                showError(`‚ùå ${t.emailTestError || 'Erro ao enviar teste!'} ${error.message}`);
            });
        }
        
        // Abrir modal de destinat√°rios
        if (recipientsBtn) {
            recipientsBtn.addEventListener('click', () => {
                if (recipientsModal) {
                    recipientsModal.classList.add('show');
                    loadRecipients();
                }
            });
        }
        
        // Fechar modal de destinat√°rios
        if (closeRecipientsModal) {
            closeRecipientsModal.addEventListener('click', () => {
                if (recipientsModal) recipientsModal.classList.remove('show');
            });
        }
        
        // Fechar modal de destinat√°rios ao clicar fora
        if (recipientsModal) {
            recipientsModal.addEventListener('click', (e) => {
                if (e.target === recipientsModal) {
                    recipientsModal.classList.remove('show');
                }
            });
        }
        
        // Salvar destinat√°rios
        if (saveRecipientsBtn) {
            saveRecipientsBtn.addEventListener('click', () => {
                saveRecipientsData();
            });
        }
        
        // Fun√ß√£o: Criar linha de destinat√°rio
        function createRecipientRow(name = '', email = '') {
            const t = translations[currentLanguage];
            const row = document.createElement('div');
            row.className = 'recipient-row';
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = t.recipientName;
            nameInput.value = name;
            nameInput.className = 'recipient-name';
            
            const emailInput = document.createElement('input');
            emailInput.type = 'text';
            emailInput.placeholder = t.recipientEmail;
            emailInput.value = email;
            emailInput.className = 'recipient-email';
            
            // Adicionar evento para criar novas linhas quando todas estiverem preenchidas
            const checkAndAddRows = () => {
                const allRows = recipientsContainer.querySelectorAll('.recipient-row');
                let allFilled = true;
                
                allRows.forEach(row => {
                    const name = row.querySelector('.recipient-name').value.trim();
                    const email = row.querySelector('.recipient-email').value.trim();
                    if (!name || !email) {
                        allFilled = false;
                    }
                });
                
                if (allFilled) {
                    // Adicionar mais 5 linhas vazias
                    for (let i = 0; i < 5; i++) {
                        recipientsContainer.appendChild(createRecipientRow());
                    }
                    // Scroll para o final
                    recipientsContainer.scrollTop = recipientsContainer.scrollHeight;
                }
            };
            
            nameInput.addEventListener('input', checkAndAddRows);
            emailInput.addEventListener('input', checkAndAddRows);
            
            row.appendChild(nameInput);
            row.appendChild(emailInput);
            
            return row;
        }
        
        // Fun√ß√£o: Carregar destinat√°rios
        function loadRecipients() {
            recipientsContainer.innerHTML = '';
            
            const prefs = loadPreferences();
            const recipients = prefs.recipients || [];
            
            if (recipients.length === 0) {
                // Criar 5 linhas vazias iniciais
                for (let i = 0; i < 5; i++) {
                    recipientsContainer.appendChild(createRecipientRow());
                }
            } else {
                // Carregar destinat√°rios salvos
                recipients.forEach(recipient => {
                    recipientsContainer.appendChild(createRecipientRow(recipient.name, recipient.email));
                });
                // Adicionar 5 linhas vazias no final
                for (let i = 0; i < 5; i++) {
                    recipientsContainer.appendChild(createRecipientRow());
                }
            }
        }
        
        // Fun√ß√£o: Salvar destinat√°rios
        function saveRecipientsData() {
            const t = translations[currentLanguage];
            const rows = recipientsContainer.querySelectorAll('.recipient-row');
            const recipients = [];
            
            rows.forEach(row => {
                const name = row.querySelector('.recipient-name').value.trim();
                const email = row.querySelector('.recipient-email').value.trim();
                
                if (name && email) {
                    recipients.push({ name, email });
                }
            });
            
            const prefs = loadPreferences();
            prefs.recipients = recipients;
            savePreferences(prefs);
            
            showInfo(`‚úÖ ${t.recipientsSaved}`);
            if (recipientsModal) recipientsModal.classList.remove('show');
        }
        
        // Fun√ß√£o: Atualizar placeholders dos destinat√°rios
        function updateRecipientPlaceholders() {
            const t = translations[currentLanguage];
            const nameInputs = document.querySelectorAll('.recipient-name');
            const emailInputs = document.querySelectorAll('.recipient-email');
            
            nameInputs.forEach(input => {
                input.placeholder = t.recipientName;
            });
            
            emailInputs.forEach(input => {
                input.placeholder = t.recipientEmail;
            });
        }
        
        // Fun√ß√£o: Verificar e enviar emails para destinat√°rios encontrados no buffer
        function checkAndSendEmails(data, timestamp) {
            const prefs = loadPreferences();
            const recipients = prefs.recipients || [];
            const emailConfig = prefs.email || {};
            
            if (recipients.length === 0) {
                return; // Sem destinat√°rios configurados
            }
            
            if (!emailConfig.senderEmail || !emailConfig.smtpServer) {
                return; // Configura√ß√£o de email incompleta
            }
            
            // Converter dados para min√∫sculas para busca case-insensitive
            const dataLower = data.toLowerCase();
            const matchedRecipients = [];
            
            // Procurar por cada nome de destinat√°rio no buffer
            recipients.forEach(recipient => {
                const nameLower = recipient.name.toLowerCase();
                if (dataLower.includes(nameLower)) {
                    matchedRecipients.push(recipient);
                }
            });
            
            // Se encontrou correspond√™ncias, enviar emails
            if (matchedRecipients.length > 0) {
                matchedRecipients.forEach(recipient => {
                    sendEmailToRecipient(recipient, data, timestamp, emailConfig);
                });
                
                const t = translations[currentLanguage];
                const names = matchedRecipients.map(r => r.name).join(', ');
                showInfo(`üìß Email enviado para: ${names}`);
            }
        }
        
        // Fun√ß√£o: Enviar email para um destinat√°rio
        async function sendEmailToRecipient(recipient, data, timestamp, emailConfig) {
            // Usando Google Apps Script - 100% gratu√≠to e ilimitado!
            
            if (!emailConfig.appsScriptUrl) {
                console.warn('‚ö†Ô∏è Google Apps Script n√£o configurado. Configure em Defini√ß√µes > Configurar Email');
                return;
            }
            
            try {
                // Separar m√∫ltiplos emails por v√≠rgula
                const emails = recipient.email.split(',').map(e => e.trim());
                
                // Enviar para cada email
                for (const email of emails) {
                    const payload = {
                        to: email,
                        toName: recipient.name,
                        fromName: emailConfig.senderName || 'LPT-UNO',
                        subject: `LPT-UNO - Dados recebidos - ${timestamp}`,
                        body: `Ol√° ${recipient.name},\n\nSegue os dados recebidos pela impressora LPT-UNO:\n\n${data}\n\n---\nEnviado automaticamente em ${new Date().toLocaleString('pt-PT')}`
                    };
                    
                    const response = await fetch(emailConfig.appsScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', // Google Apps Script requer no-cors
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    // No-cors n√£o retorna resposta, assumimos sucesso se n√£o houver erro
                    console.log('‚úÖ Email enviado para:', recipient.name, '<' + email + '>');
                    console.log('   Via Google Apps Script');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar email via Google Apps Script:', error);
                console.log('üí° Verifique a URL do Apps Script em Defini√ß√µes > Configurar Email');
            }
        }
        
        // Fun√ß√£o: Carregar configura√ß√µes de email
        function loadEmailConfig() {
            const prefs = loadPreferences();
            const email = prefs.email || {};
            
            document.getElementById('appsScriptUrl').value = email.appsScriptUrl || '';
            document.getElementById('senderName').value = email.senderName || 'LPT-UNO';
        }
        
        // Fun√ß√£o: Salvar configura√ß√µes de email
        function saveEmailConfig() {
            const prefs = loadPreferences();
            prefs.email = {
                appsScriptUrl: document.getElementById('appsScriptUrl').value,
                senderName: document.getElementById('senderName').value
            };
            savePreferences(prefs);
            
            showInfo(`‚úÖ ${translations[currentLanguage].emailConfigSaved}`);
            if (emailConfigModal) emailConfigModal.classList.remove('show');
        }
        
        // Aplicar tradu√ß√µes inicial ap√≥s todos os elementos estarem prontos
        applyTranslations(currentLanguage);
        
        // Fun√ß√£o: Mostrar erro
        function showError(message) {
            errorMsg.textContent = '‚ùå ' + message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }
        
        // Fun√ß√£o: Mostrar info
        function showInfo(message) {
            infoMsg.textContent = '‚ÑπÔ∏è ' + message;
            infoMsg.style.display = 'block';
            setTimeout(() => {
                infoMsg.style.display = 'none';
            }, 3000);
        }
        
        // Fun√ß√£o: Resetar timer de inatividade
        function resetInactivityTimer() {
            lastDataTime = Date.now();
            
            // Limpar timer anterior
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Obter tempo configurado (em segundos)
            const prefs = loadPreferences();
            const timeInSeconds = prefs.autoSaveTime || 10;
            
            // Criar novo timer com tempo configurado
            inactivityTimer = setTimeout(() => {
                handleInactivity();
            }, timeInSeconds * 1000);
        }
        
        // Fun√ß√£o: Lidar com inatividade (10 segundos sem dados)
        function handleInactivity() {
            if (!pendingData || pendingData.trim().length === 0) {
                return; // Nada para processar
            }
            
            const timestamp = generateTimestamp();
            const shouldClearMonitor = autoSaveBtn.classList.contains('active') || autoPrintBtn.classList.contains('active');
            
            // Auto-salvar se habilitado
            if (autoSaveBtn.classList.contains('active')) {
                const blob = new Blob([pendingData], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LPT-UNO_${timestamp}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showInfo('‚úÖ Arquivo salvo automaticamente: LPT-UNO_' + timestamp + '.txt');
                
                // Verificar se h√° destinat√°rios correspondentes no buffer
                checkAndSendEmails(pendingData, timestamp);
            }
            
            // Auto-imprimir se habilitado
            if (autoPrintBtn.classList.contains('active')) {
                printData(pendingData);
            }
            
            // Limpar dados pendentes
            pendingData = '';
            
            // Limpar monitor apenas se auto-salvar ou auto-imprimir estiver ativo
            if (shouldClearMonitor) {
                output.textContent = '';
                byteCount = 0;
                byteCountEl.textContent = '0';
            }
        }
        
        // Fun√ß√£o: Imprimir dados na impressora padr√£o
        function printData(data) {
            try {
                // Criar iframe invis√≠vel para impress√£o
                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'absolute';
                printFrame.style.width = '0';
                printFrame.style.height = '0';
                printFrame.style.border = 'none';
                document.body.appendChild(printFrame);
                
                // Escrever conte√∫do no iframe
                const doc = printFrame.contentWindow.document;
                doc.open();
                doc.write('<html><head><meta charset="UTF-8"><title>LPT-UNO Print</title>');
                doc.write('<style>body { font-family: "Courier New", monospace; white-space: pre-wrap; }</style>');
                doc.write('</head><body>');
                doc.write(data.replace(/</g, '&lt;').replace(/>/g, '&gt;'));
                doc.write('</body></html>');
                doc.close();
                
                // Aguardar carregamento e imprimir
                printFrame.contentWindow.focus();
                setTimeout(() => {
                    printFrame.contentWindow.print();
                    showInfo('üñ®Ô∏è Enviado para impressora padr√£o');
                    
                    // Remover iframe ap√≥s impress√£o
                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                    }, 1000);
                }, 500);
                
            } catch (error) {
                showError('Erro ao imprimir: ' + error.message);
            }
        }
        
        // ========================================
        // SISTEMA DE TEMAS
        // ========================================
        const themeSelect = document.getElementById('themeSelect');
        
        function applyTheme(theme) {
            // Remover todos os temas
            document.body.classList.remove('dark-mode', 'ocean-theme', 'forest-theme', 'sunset-theme');
            
            // Aplicar novo tema
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'ocean') {
                document.body.classList.add('ocean-theme');
            } else if (theme === 'forest') {
                document.body.classList.add('forest-theme');
            } else if (theme === 'sunset') {
                document.body.classList.add('sunset-theme');
            }
            
            // Salvar prefer√™ncia
            const prefs = loadPreferences();
            prefs.theme = theme;
            savePreferences(prefs);
            
            const themeNames = {
                light: '‚òÄÔ∏è Light Mode',
                dark: 'üåô Dark Mode',
                ocean: 'üåä Ocean Theme',
                forest: 'üå≤ Forest Theme',
                sunset: 'üåÖ Sunset Theme'
            };
            
            showInfo(themeNames[theme] + ' ativado!');
        }
        
        if (themeSelect) {
            themeSelect.addEventListener('change', () => {
                applyTheme(themeSelect.value);
            });
        }
        
        // Aplicar tema salvo
        const savedPrefs = loadPreferences();
        const savedTheme = savedPrefs.theme || 'light';
        if (themeSelect) themeSelect.value = savedTheme;
        applyTheme(savedTheme);
        
        // Aplicar idioma salvo
        const savedLang = savedPrefs.language || 'en';
        if (languageSelect) languageSelect.value = savedLang;
        applyTranslations(savedLang);
        
        // Aplicar formato de salvamento
        const savedFormat = savedPrefs.saveFormat || 'txt';
        const formatRadio = document.querySelector(`input[name="saveFormat"][value="${savedFormat}"]`);
        if (formatRadio) {
            formatRadio.checked = true;
            formatRadio.closest('[data-format]')?.classList.add('selected');
        }
        
        // Aplicar prefer√™ncias salvas: Auto-salvar (padr√£o true)
        if (savedPrefs.autoSave !== false) { // Default true
            if (!autoSaveBtn.classList.contains('active')) {
                autoSaveBtn.classList.add('active');
            }
        } else {
            autoSaveBtn.classList.remove('active');
        }

        // Aplicar prefer√™ncias salvas: Auto-imprimir (restaurar estado)
        if (savedPrefs.autoPrint && savedPrefs.autoSave !== false) {
             if (!autoPrintBtn.classList.contains('active')) {
                autoPrintBtn.classList.add('active');
                
                // Aviso de 1¬™ vez sobre o modo Kiosk
                if (!sessionStorage.getItem('kioskWarningShown')) {
                    console.log('Modo Auto-imprimir restaurado. Certifique-se de estar usando o --kiosk-printing.');
                    sessionStorage.setItem('kioskWarningShown', 'true');
                }
             }
        } else {
            autoPrintBtn.classList.remove('active');
        }
        
        // ========================================
        // NOTIFICA√á√ïES DESKTOP
        // ========================================
        const notificationsToggle = document.getElementById('notificationsToggle');
        let notificationsEnabled = false;
        
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                notificationsEnabled = (permission === 'granted');
                
                if (notificationsEnabled) {
                    showInfo('üîî Notifica√ß√µes ativadas!');
                    if (notificationsToggle) notificationsToggle.classList.add('active');
                } else {
                    showError('‚ùå Permiss√£o de notifica√ß√µes negada');
                    if (notificationsToggle) notificationsToggle.classList.remove('active');
                }
                
                // Salvar prefer√™ncia
                const prefs = loadPreferences();
                prefs.notifications = notificationsEnabled;
                savePreferences(prefs);
            }
        }
        
        function sendNotification(title, body) {
            if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üñ®Ô∏è</text></svg>'
                });
            }
        }
        
        if (notificationsToggle) {
            notificationsToggle.addEventListener('click', () => {
                if (notificationsEnabled) {
                    notificationsEnabled = false;
                    notificationsToggle.classList.remove('active');
                    showInfo('üîï Notifica√ß√µes desativadas');
                    
                    const prefs = loadPreferences();
                    prefs.notifications = false;
                    savePreferences(prefs);
                } else {
                    requestNotificationPermission();
                }
            });
        }
        
        // Verificar se notifica√ß√µes estavam ativas
        if (savedPrefs.notifications && 'Notification' in window && Notification.permission === 'granted') {
            notificationsEnabled = true;
            if (notificationsToggle) notificationsToggle.classList.add('active');
        }
        
        // ========================================
        // HIST√ìRICO DE SESS√ïES
        // ========================================
        const openSessionHistory = document.getElementById('openSessionHistory');
        const sessionHistoryModal = document.getElementById('sessionHistoryModal');
        const closeSessionHistory = document.getElementById('closeSessionHistory');
        const clearSessionHistory = document.getElementById('clearSessionHistory');
        const sessionHistoryList = document.getElementById('sessionHistoryList');
        
        function saveSession(data) {
            if (!data || data.trim().length === 0) return;
            
            const sessions = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
            
            sessions.unshift({
                timestamp: new Date().toISOString(),
                data: data,
                bytes: data.length
            });
            
            // Manter apenas √∫ltimas 10 sess√µes
            if (sessions.length > 10) {
                sessions.pop();
            }
            
            localStorage.setItem('sessionHistory', JSON.stringify(sessions));
        }
        
        function loadSessionHistory() {
            const sessions = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
            
            if (sessions.length === 0) {
                sessionHistoryList.innerHTML = `
                    <p style="padding: 20px; text-align: center; color: #6c757d;">
                        Nenhuma sess√£o salva ainda
                    </p>
                `;
                return;
            }
            
            sessionHistoryList.innerHTML = sessions.map((session, index) => {
                const date = new Date(session.timestamp);
                const preview = session.data.substring(0, 100) + (session.data.length > 100 ? '...' : '');
                
                return `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>üìÖ ${date.toLocaleString('pt-PT')}</strong>
                            <span style="color: #6c757d;">${session.bytes} bytes</span>
                        </div>
                        <pre style="background: #fff; padding: 10px; border-radius: 3px; margin: 10px 0; max-height: 100px; overflow: auto; font-size: 0.85em;">${preview}</pre>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="restoreSession(${index})" class="modal-btn" style="flex: 1; padding: 8px; font-size: 0.9em; background: #28a745;">
                                ‚ôªÔ∏è Restaurar
                            </button>
                            <button onclick="deleteSession(${index})" class="modal-btn" style="flex: 1; padding: 8px; font-size: 0.9em; background: #dc3545;">
                                üóëÔ∏è Deletar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        window.restoreSession = function(index) {
            const sessions = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
            if (sessions[index]) {
                output.textContent = sessions[index].data;
                sessionHistoryModal.classList.remove('show');
                showInfo('‚úÖ Sess√£o restaurada!');
            }
        };
        
        window.deleteSession = function(index) {
            const sessions = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
            sessions.splice(index, 1);
            localStorage.setItem('sessionHistory', JSON.stringify(sessions));
            loadSessionHistory();
            showInfo('üóëÔ∏è Sess√£o deletada!');
        };
        
        if (openSessionHistory) {
            openSessionHistory.addEventListener('click', () => {
                sessionHistoryModal.classList.add('show');
                loadSessionHistory();
            });
        }
        
        if (closeSessionHistory) {
            closeSessionHistory.addEventListener('click', () => {
                sessionHistoryModal.classList.remove('show');
            });
        }
        
        if (clearSessionHistory) {
            clearSessionHistory.addEventListener('click', () => {
                if (confirm('Deseja limpar todas as sess√µes salvas?')) {
                    localStorage.removeItem('sessionHistory');
                    loadSessionHistory();
                    showInfo('üóëÔ∏è Hist√≥rico de sess√µes limpo!');
                }
            });
        }
        
        // TABS: Alternar entre Sess√µes e Backups
        // ========================================
        const tabSessions = document.getElementById('tabSessions');
        const tabBackups = document.getElementById('tabBackups');
        const sessionsContent = document.getElementById('sessionsContent');
        const backupsContent = document.getElementById('backupsContent');
        
        if (tabSessions) {
            tabSessions.addEventListener('click', () => {
                // Ativar tab Sess√µes
                tabSessions.classList.add('active');
                tabSessions.style.borderBottom = '3px solid #667eea';
                tabBackups.classList.remove('active');
                tabBackups.style.borderBottom = '3px solid transparent';
                
                // Mostrar conte√∫do
                sessionsContent.style.display = 'block';
                backupsContent.style.display = 'none';
                
                loadSessionHistory();
            });
        }
        
        if (tabBackups) {
            tabBackups.addEventListener('click', () => {
                // Ativar tab Backups
                tabBackups.classList.add('active');
                tabBackups.style.borderBottom = '3px solid #667eea';
                tabSessions.classList.remove('active');
                tabSessions.style.borderBottom = '3px solid transparent';
                
                // Mostrar conte√∫do
                backupsContent.style.display = 'block';
                sessionsContent.style.display = 'none';
                
                loadBackupList();
            });
        }
        
        // INTERFACE DE BACKUPS
        // ========================================
        const refreshBackups = document.getElementById('refreshBackups');
        const exportAllBackupsBtn = document.getElementById('exportAllBackups');
        const clearAllBackups = document.getElementById('clearAllBackups');
        const backupList = document.getElementById('backupList');
        const backupCount = document.getElementById('backupCount');
        
        async function loadBackupList() {
            try {
                const backups = await listBackups();
                
                // Atualizar contador
                if (backupCount) {
                    backupCount.innerHTML = `
                        <strong>üìä Total de backups:</strong> ${backups.length} / ${MAX_BACKUPS}
                        ${backups.length > 0 ? `| <strong>√öltimo backup:</strong> ${new Date(backups[0].timestamp).toLocaleString('pt-PT')}` : ''}
                    `;
                }
                
                if (backups.length === 0) {
                    backupList.innerHTML = `
                        <p style="padding: 20px; text-align: center; color: #6c757d;">
                            Nenhum backup encontrado
                        </p>
                    `;
                    return;
                }
                
                backupList.innerHTML = backups.map(backup => {
                    const date = new Date(backup.timestamp);
                    const preview = backup.data.substring(0, 80) + (backup.data.length > 80 ? '...' : '');
                    const savedBadge = backup.saved ? '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">‚úÖ Salvo</span>' : '';
                    
                    return `
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px;">
                                <strong>üìÖ ${date.toLocaleString('pt-PT')}</strong>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    ${savedBadge}
                                    <span style="color: #6c757d; font-size: 0.9em;">${backup.size} bytes</span>
                                    ${backup.subfolder ? `<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">üìÅ ${backup.subfolder}</span>` : ''}
                                </div>
                            </div>
                            <pre style="background: #fff; padding: 10px; border-radius: 3px; margin: 10px 0; max-height: 80px; overflow: auto; font-size: 0.8em;">${preview}</pre>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="restoreBackup('${backup.id}')" class="modal-btn" style="flex: 1; min-width: 120px; padding: 8px; font-size: 0.9em; background: #28a745;">
                                    ‚ôªÔ∏è Restaurar
                                </button>
                                <button onclick="downloadBackup('${backup.id}')" class="modal-btn" style="flex: 1; min-width: 120px; padding: 8px; font-size: 0.9em; background: #17a2b8;">
                                    üíæ Download
                                </button>
                                <button onclick="deleteBackup('${backup.id}')" class="modal-btn" style="flex: 1; min-width: 120px; padding: 8px; font-size: 0.9em; background: #dc3545;">
                                    üóëÔ∏è Deletar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar backups:', error);
                backupList.innerHTML = `
                    <p style="padding: 20px; text-align: center; color: #dc3545;">
                        ‚ùå Erro ao carregar backups: ${error.message}
                    </p>
                `;
            }
        }
        
        // Fun√ß√µes globais para backup
        window.restoreBackup = async function(id) {
            try {
                const backup = await getBackup(id);
                if (backup && backup.data) {
                    output.textContent = backup.data;
                    pendingData = backup.data;
                    byteCount = backup.data.length;
                    updateStats();
                    sessionHistoryModal.classList.remove('show');
                    showInfo(`‚úÖ Backup restaurado! (${backup.size} bytes)`);
                }
            } catch (error) {
                console.error('Erro ao restaurar backup:', error);
                showInfo(`‚ùå Erro ao restaurar backup: ${error.message}`);
            }
        };
        
        window.downloadBackup = async function(id) {
            try {
                const backup = await getBackup(id);
                if (backup && backup.data) {
                    const date = new Date(backup.timestamp);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    const timestamp = `${day}-${month}-${year}_${hours}h${minutes}m${seconds}s`;
                    const filename = backup.subfolder ? `${backup.subfolder}_${timestamp}.txt` : `backup_${timestamp}.txt`;
                    
                    const blob = new Blob([backup.data], { type: 'text/plain; charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    // Marcar como salvo
                    await markBackupAsSaved(id);
                    loadBackupList();
                    
                    showInfo(`üíæ Backup baixado: ${filename}`);
                }
            } catch (error) {
                console.error('Erro ao baixar backup:', error);
                showInfo(`‚ùå Erro ao baixar backup: ${error.message}`);
            }
        };
        
        window.deleteBackup = async function(id) {
            if (!confirm('Deseja deletar este backup?')) return;
            
            try {
                const db = await openBackupDB();
                const transaction = db.transaction(BACKUP_STORE, 'readwrite');
                const store = transaction.objectStore(BACKUP_STORE);
                
                await new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                loadBackupList();
                showInfo('üóëÔ∏è Backup deletado!');
            } catch (error) {
                console.error('Erro ao deletar backup:', error);
                showInfo(`‚ùå Erro ao deletar backup: ${error.message}`);
            }
        };
        
        if (refreshBackups) {
            refreshBackups.addEventListener('click', () => {
                loadBackupList();
                showInfo('üîÑ Lista de backups atualizada!');
            });
        }
        
        if (exportAllBackupsBtn) {
            exportAllBackupsBtn.addEventListener('click', async () => {
                try {
                    await exportAllBackups();
                } catch (error) {
                    console.error('Erro ao exportar backups:', error);
                    showInfo(`‚ùå Erro ao exportar: ${error.message}`);
                }
            });
        }
        
        if (clearAllBackups) {
            clearAllBackups.addEventListener('click', async () => {
                if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Deseja deletar TODOS os backups? Esta a√ß√£o n√£o pode ser desfeita!')) return;
                
                try {
                    const db = await openBackupDB();
                    const transaction = db.transaction(BACKUP_STORE, 'readwrite');
                    const store = transaction.objectStore(BACKUP_STORE);
                    
                    await new Promise((resolve, reject) => {
                        const request = store.clear();
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                    
                    loadBackupList();
                    showInfo('üóëÔ∏è Todos os backups foram deletados!');
                } catch (error) {
                    console.error('Erro ao limpar backups:', error);
                    showInfo(`‚ùå Erro ao limpar backups: ${error.message}`);
                }
            });
        }
        
        // Salvar sess√£o automaticamente ao desconectar
        const originalDisconnect = disconnect;
        window.disconnect = async function() {
            if (output.textContent.trim().length > 0) {
                saveSession(output.textContent);
            }
            await originalDisconnect();
        };
        
        // Modificar sendEmailToRecipient para adicionar notifica√ß√£o
        const originalSendEmail = sendEmailToRecipient;
        window.sendEmailToRecipient = async function(recipient, data, timestamp, emailConfig) {
            try {
                await originalSendEmail(recipient, data, timestamp, emailConfig);
                sendNotification('Email Enviado', 'Para: ' + recipient.name);
            } catch (error) {
                sendNotification('Erro ao Enviar Email', 'Para: ' + recipient.name);
            }
        };
        
        // ========================================
        // INICIALIZA√á√ÉO AUTOM√ÅTICA DO SISTEMA
        // ========================================
        (function() {
            console.log('‚úÖ Sistema LPT-UNO iniciado');
            console.log('üíæ Arquivos ser√£o salvos na pasta Downloads');
            console.log('üîÑ Sistema de backup autom√°tico via IndexedDB');
            
            // Iniciar sistema de backup autom√°tico
            startAutoBackupSystem();
            
            // Detec√ß√£o autom√°tica de dispositivo (Auto-Connect)
            setTimeout(tryAutoConnect, 1000); // 1s de delay para garantir renderiza√ß√£o correta
        })();
    </script>
</body>
</html>
